# 神託 - 高額部品抽出ツール機能拡張仕様

**受領日**: 2026-01-28
**対象**: parts_extractor アプリケーション

---

## 機能拡張概要

### 1. 略式型式での曖昧検索機能 ⭐
**要件**: 略式型式（short_model）で部分一致検索を可能にする

**実装内容**:
- 検索ボックスUIを追加（`ui.py`）
- 部分一致検索ロジックを実装（`data_analyzer.py`）
- 大文字小文字を区別しない検索
- 金額フィルタと組み合わせ可能（AND条件）

**受け入れ基準**:
- ✅ 「ABC123」と入力すると、short_modelに「ABC123」を含む行のみ表示
- ✅ 空欄の場合は全件表示
- ✅ 金額フィルタと併用可能

---

### 2. 最低金額から10件取得機能 ⭐
**要件**: 最低金額から順に指定件数のみ取得

**実装内容**:
- 「上位N件のみ表示」チェックボックスを追加（`ui.py`）
- 件数入力スピンボックス（デフォルト: 10件）
- 件数制限ロジックを実装（`data_analyzer.py`）

**受け入れ基準**:
- ✅ チェックON → 最低金額から10件のみ表示
- ✅ チェックOFF → 全件表示
- ✅ 件数は1〜1000の範囲で変更可能

---

### 3. 列ヘッダークリックでのソート機能 ⭐⭐
**要件**: Treeviewの列ヘッダーをクリックすると昇順/降順にソート

**実装内容**:
- 列ヘッダーにクリックイベントを追加（`ui.py`）
- ソート状態管理（列名、昇順/降順）
- ソートインジケータ表示（▲▼）

**受け入れ基準**:
- ✅ 列をクリック → その列で昇順ソート
- ✅ 再度クリック → 降順に切り替え
- ✅ ソート方向が視覚的に明確（▲▼表示）
- ✅ 全列でソート可能

---

### 4. ダブルクリックで詳細ポップアップ表示 ⭐⭐⭐
**要件**: 行をダブルクリックすると全情報をポップアップ表示

**実装内容**:
- ダブルクリックイベントハンドラ（`ui.py`）
- 詳細表示ダイアログ（Toplevel）
- 全列情報の表示

**受け入れ基準**:
- ✅ 任意の行をダブルクリックで詳細ウィンドウが開く
- ✅ 全ての列情報が表示される
- ✅ ウィンドウは独立動作し、閉じても影響なし

---

### 5. ポップアップUIの視認性最適化 ⭐⭐⭐
**要件**: 縦横比3:4で視認性の高いレイアウト

**実装内容**:
- ウィンドウサイズ: 600px × 800px（3:4比率）
- カテゴリ別グループ化（LabelFrame使用）
  - 基本情報（部品管理番号、部品名、価格）
  - 車両情報（車名、型式、カラー、年式、エンジン）
  - 在庫・品質情報（ステータス、品質区分、保管場所）
  - その他情報（部品コード、メーカー、登録日）
- スクロール対応（項目数が多い場合）
- 「閉じる」ボタン

**受け入れ基準**:
- ✅ ウィンドウサイズが縦横比3:4
- ✅ 情報がカテゴリ別に整理
- ✅ 項目名と値が明確に区別可能
- ✅ スクロール可能（必要時）
- ✅ 視認性が高く読みやすい

---

## 実装計画

### Phase 1: データ処理基盤
**ファイル**: `data_analyzer.py`
1. 略式型式検索メソッド追加
   ```python
   def filter_by_short_model(self, search_term: str) -> pd.DataFrame
   ```
2. 件数制限機能追加
   ```python
   def filter_by_amount(self, min_amount: float, limit: Optional[int] = None) -> pd.DataFrame
   ```

### Phase 2: UI機能追加
**ファイル**: `ui.py`
1. 検索ボックスUI（略式型式検索）
2. 件数制限UI（チェックボックス + スピンボックス）
3. 列ヘッダークリックソート機能
   - イベントハンドラ: `_on_column_header_click()`
   - ソート状態管理変数追加

### Phase 3: 詳細表示機能
**ファイル**: `ui.py`
1. ダブルクリックイベント実装
   - イベントバインド: `self.tree.bind("<Double-Button-1>", ...)`
   - ハンドラ: `_on_row_double_click()`
2. 詳細ダイアログ実装
   - メソッド: `_show_detail_dialog()`
   - レイアウト設計（3:4比率、カテゴリ別）

---

## 影響ファイル

### 主要ファイル
- ✏️ `ui.py`: UI要素追加、イベントハンドラ実装、詳細ダイアログ実装
- ✏️ `data_analyzer.py`: 検索/件数制限ロジック追加
- 📖 `config.py`: 必要に応じて設定追加（検索設定など）

### 維持するファイル
- ✅ `main.py`: 変更なし
- ✅ `sheets_api.py`: 変更なし
- ✅ `mock_data.py`: 変更なし
- ✅ `data_storage.py`: 変更なし

---

## 非機能要件

### パフォーマンス
- 大量データ（10,000件以上）でもソートが1秒以内
- 検索フィルタが即座に反映

### ユーザビリティ
- 直感的なUI（説明不要）
- 適切なエラーメッセージ
- ソート状態の視覚的明示

### 互換性
- 既存のCSVエクスポート、JSON保存機能を維持
- 既存のモックデータ、Google Sheets API連携を維持

---

## テスト項目

### 機能テスト
- [ ] 略式型式検索で正しくフィルタリングされるか
- [ ] 件数制限が正しく適用されるか
- [ ] 全列でソートが正常に動作するか
- [ ] ダブルクリックで正しい行の詳細が表示されるか
- [ ] ポップアップUIが要件通りのレイアウトか

### 統合テスト
- [ ] 金額フィルタ + 略式型式検索の複合条件
- [ ] 金額フィルタ + 件数制限の組み合わせ
- [ ] ソート後のCSVエクスポート
- [ ] 詳細ポップアップからのデータコピー（可能であれば）

### UIテスト
- [ ] ソートインジケータが正しく表示されるか
- [ ] ポップアップウィンドウが独立して動作するか
- [ ] エラー時に適切なメッセージが表示されるか

---

## 成功の定義

以下の全てが満たされたとき、神託は遂行されたと見なす:

✅ 略式型式で部分一致検索ができる
✅ 最低金額から指定件数を取得できる
✅ 列ヘッダークリックで昇順/降順ソートができる
✅ 行ダブルクリックで全情報がポップアップ表示される
✅ ポップアップUIが視認性が高く、縦横比3:4である
✅ 既存機能が正常に動作する
✅ 全テストが合格する

---

**詳細技術仕様**: `memory/prophet_divine_revelation_20260128.md` を参照

*預言者より - 2026-01-28*
