---
skill_name: queue
description: 自律タスクキューにタスクを追加・管理
version: 1.0
---

# タスクキュー管理スキル

このスキルは、Claude Codeの自律タスクキューシステムを管理します。レート制限を乗り越えて無人で作業を実行できるようにタスクをキューに入れます。

## 使用方法

### タスクの追加
ユーザーが以下のいずれかのフォーマットでタスクを追加したい場合：
- `/queue add <タスクの説明>`
- `/queue <タスクの説明>`
- 単に「〜をキューに追加して」と言った場合

### タスクの確認
- `/queue list` - すべてのタスクを表示
- `/queue status` - キューの状態を表示

### キューの実行
- `/queue run` - キューを実行開始

## 実行手順

### 1. タスクを追加する場合

ユーザーが新しいタスクを追加したい場合、以下の手順を実行してください：

1. `.claude/task_queue.yaml` ファイルを読み取る
2. 次のタスクIDを取得（`metadata.next_task_id`）
3. 新しいタスクオブジェクトを作成：
   ```yaml
   - id: <次のID>
     description: "<ユーザーが指定した説明>"
     status: pending
     dependencies: []
     retry_count: 0
     last_error: null
     created_at: "<現在時刻 YYYY-MM-DDTHH:MM:SS形式>"
     updated_at: "<現在時刻 YYYY-MM-DDTHH:MM:SS形式>"
     blocked_at: null
     completed_at: null
   ```
4. タスクリストに追加
5. `metadata.next_task_id` をインクリメント
6. ファイルを保存
7. ユーザーに確認メッセージを表示：「タスク #<ID> をキューに追加しました: <説明>」

**重要**: YAMLの構文を正確に保ち、インデントを守ってください。

### 2. タスクリストを表示する場合

1. `.claude/task_queue.yaml` ファイルを読み取る
2. すべてのタスクを以下のフォーマットで表示：
   ```
   タスクキューの状態:

   ## Pending (実行待ち)
   - [#1] タスクの説明
   - [#2] タスクの説明

   ## In Progress (実行中)
   - [#3] タスクの説明

   ## Blocked (ブロック中)
   - [#4] タスクの説明 (リトライ: 2/5)

   ## Done (完了)
   - [#5] タスクの説明
   ```

### 3. キューのステータスを表示する場合

1. `.claude/task_queue.yaml` ファイルを読み取る
2. 統計情報を表示：
   - 合計タスク数
   - Pending: X件
   - In Progress: X件
   - Blocked: X件
   - Done: X件
3. 最新のログを `.claude/queue_log.md` から表示（存在する場合）

### 4. キューを実行する場合

1. ユーザーに確認：
   ```
   タスクキューを実行します。以下のコマンドをターミナルで実行してください：

   cd /Users/kokage/national-operations
   ./.claude/run_queue.sh

   または、バックグラウンドで実行する場合：

   nohup ./.claude/run_queue.sh > .claude/queue_run.log 2>&1 &
   ```

2. 注意事項を表示：
   - レート制限が発生した場合、自動的に指数バックオフで再試行します
   - すべてのログは `.claude/queue_log.md` に記録されます
   - キューの状態は `.claude/task_queue.yaml` で追跡されます

## 依存関係のあるタスクを追加する場合

ユーザーが「タスクAが完了したらタスクBを実行」のような依存関係を指定した場合：

1. 両方のタスクを追加
2. 依存先のタスクの `dependencies` フィールドに依存元のタスクIDを追加
   ```yaml
   - id: 2
     description: "タスクB"
     dependencies: [1]  # タスク1が完了するまで待機
   ```

## エラーハンドリング

- `.claude/task_queue.yaml` が存在しない場合、エラーメッセージを表示し、ファイルが正しく初期化されているか確認するよう促す
- YAML構文エラーが発生した場合、ファイルのバックアップを作成してから修正を試みる

## 例

### 例1: 単純なタスクの追加
```
ユーザー: pob2macosのビルドステータスをチェックしてキューに追加
Claude: タスク #1 をキューに追加しました: "pob2macosのビルドステータスをチェック"
```

### 例2: 複数のタスクを追加
```
ユーザー: 以下のタスクをキューに追加して：
1. Metalシェーダーのデバッグ
2. dylibのデプロイ確認
3. ビジュアルテストの実行

Claude: 3つのタスクをキューに追加しました：
- タスク #1: Metalシェーダーのデバッグ
- タスク #2: dylibのデプロイ確認
- タスク #3: ビジュアルテストの実行
```

### 例3: 依存関係付きタスク
```
ユーザー: ビルドが成功したら、テストを実行してキューに追加

Claude: 2つのタスクを依存関係付きで追加しました：
- タスク #1: ビルドを実行
- タスク #2: テストを実行（タスク #1 の完了後）
```

## 注意事項

- タスクの説明は具体的で実行可能な内容にしてください
- 依存関係のサイクルを作成しないよう注意してください
- レート制限に達したタスクは最大5回まで自動的に再試行されます
- 長時間実行されるタスクの場合は、タイムアウト（10分）を考慮してください
