# テキスト入力不具合の失敗経験と成功例 (2026-02-10)

## 失敗経験
- フォーカス判定を `selControl.hasFocus` のみに依存すると、クリック直後の1文字目や削除が落ちるケースを見逃した。
- `DrawStringCursorIndex` が 0 を返すケースを想定せず、1文字目が未反映・逆順表示（例: `qwerty` が `wertq`）につながった。
- 文字入力の問題を「ショートカット誤発火」だけで説明しようとして、キャレット位置の不整合を後回しにした。
- `Char` イベントが先に到達しても `selControl` が未確定な場合がある点を軽視した。

## 成功例
- `EditControl` のキャレット値を `1..(#buf+1)` にクランプして、1文字目の未反映と逆順表示を解消できた。
- `main.textInputActive` を導入し、テキスト入力中はショートカット処理を抑止して誤発火を止められた。
- `ControlHost` 側で `Char`/`KeyDown` 時にマウスオーバーの `EditControl` を選択するガードを入れ、入力対象を安定させた。
- `CharInput` と `EditControl` のデバッグログで事象の再現と修正効果を検証できた。

## 再発防止メモ
- 文字入力の不具合は「フォーカス」「キャレット」「入力順序」の3点を必ず同時に見る。
- 1文字目が消える症状は `caret=0` の可能性を最初に疑う。
