# テキストレンダリング不完全問題の分析

**日付**: 2026-02-02 00:10
**状態**: 調査中
**前回の修正**: フラグメントシェーダーデバッグスタブ削除、グリフアトラスRGBAマッピング修正

---

## 視覚的検証結果（スクリーンショット確認済み）

### 期待される表示:
- ✅ 青い背景（RGB ≈ 0.2, 0.3, 0.5）
- ✅ 白いテキスト: "VISUAL TEST - Metal Fragment Shader Fix"
- ✅ 白いテキスト: "If you can see this text AND the image below, the fix works!"
- ✅ 黄色いテキスト: "Frame: XX"
- ✅ 黄色いテキスト: "Text rendering: WORKING"
- ✅ Ring.png画像（256x256ピクセル、位置200,250）
- ✅ 緑色のテキスト: "Image rendering: (ring.png below)"

### 実際の表示:
- ✅ 青い背景が見える
- ❌ 白いテキスト「VISUAL TEST...」が見えない
- ⚠️ 白いテキスト「below, the fix works!」の**一部のみ**見える
- ❌ 黄色いテキスト「Frame: XX」が見えない
- ❌ 黄色いテキスト「Text rendering: WORKING」が見えない
- ❌ Ring.png画像が見えない（ユーザー報告: 「白い円の線が極稀に表示される」）
- ✅ 緑色のテキスト「Image rendering: (ring.png below)」が見える

### 改善された点（前回の修正により）:
- ✅ 純粋な赤い画面 → 青い背景（フラグメントシェーダー修正の効果）
- ✅ 黒い四角の明滅 → 完全に消えた（RGBAマッピング修正の効果）
- ✅ 一部のテキストが正しい色で表示される（白、緑）

### 残存する問題:
- ❌ テキストの大部分が表示されない
- ❌ Ring.png画像が常時表示されない（極稀にのみ表示）

---

## 根本原因分析

### 仮説1: グリフアトラスの容量不足または更新タイミング問題

**観察**:
- 一部のテキストは表示される（「below, the fix works!」「Image rendering:」）
- 他のテキストは表示されない（「VISUAL TEST」「Frame: XX」）

**可能性**:
- グリフアトラスが満杯になり、後から描画される文字が登録されない
- アトラスの更新タイミングが遅く、最初のフレームで文字が準備されていない
- sg_text.cpp:241-248 の警告（comparison of different signs）が関連？

**検証方法**:
- グリフアトラスのサイズ確認（ATLAS_WIDTH, ATLAS_HEIGHT）
- 各DrawStringのタイミングと順序を確認
- アトラスのcurrent_x, current_y の値をログ出力

---

### 仮説2: 頂点カラーのアルファ値が0になっている

**観察**:
- 緑色のテキストは表示される
- 白色、黄色のテキストは表示されない
- Ring.png画像も表示されない

**可能性**:
- SetDrawColor()で設定される頂点カラーのアルファ値が0になっている
- フラグメントシェーダーの `texColor * in.color` でアルファが0になり、透明化

**検証方法**:
- visual_test.luaでSetDrawColor()の呼び出しを確認
- 各色のアルファ値が1.0になっているか確認
- sg_draw.cppでSetDrawColor()の実装を確認

---

###仮説3: テクスチャレイヤーインデックスの問題

**観察**:
- Ring.png画像が「極稀に白い円の線」として表示
- これは画像が描画されているが、テクスチャサンプリングが間違っている可能性

**可能性**:
- テクスチャ配列のレイヤーインデックスが間違っている
- `uint(in.texCoord.z)` の値が期待と異なる
- グリフアトラスと画像テクスチャが混在し、間違ったレイヤーをサンプリング

**検証方法**:
- フラグメントシェーダーでin.texCoord.zの値をログ出力
- 各DrawImageで渡されるテクスチャハンドルとレイヤーインデックスを確認
- グリフアトラスと通常テクスチャのレイヤー割り当てを確認

---

### 仮説4: バッチングまたはフラッシュタイミングの問題

**観察**:
- ログには「DIAG-GLYPH-FLUSH: Flushed 198 vertices」などが表示
- しかし視覚的には多くのテキストが見えない

**可能性**:
- 頂点バッファがフラッシュされているが、描画コマンドが実行されていない
- renderEncoderの状態が間違っている
- パイプラインステートが正しく設定されていない

**検証方法**:
- metal_backend.mmのflush_*()関数でrenderEncoderがNULLでないか確認
- drawIndexedPrimitives呼び出しが実際に実行されているか確認
- Metalデバッガーでフレームキャプチャ

---

## 最も可能性の高い仮説

**仮説2: 頂点カラーのアルファ値が0**が最も可能性が高い。

**理由**:
1. 緑色のテキストは表示されるが、白色・黄色は表示されない
2. Ring.png画像も表示されない（頂点カラーが適用される）
3. フラグメントシェーダーは `texColor * in.color` を返す
4. in.color.a = 0 なら、結果のアルファは0 → 透明

**次のステップ**:
1. visual_test.lua を読んで、SetDrawColor()の呼び出しを確認
2. sg_draw.cpp を読んで、SetDrawColor()の実装を確認
3. 頂点カラーが正しく設定されているか確認

---

## 調査優先順位

1. **HIGH**: visual_test.lua のSetDrawColor()呼び出し確認
2. **HIGH**: sg_draw.cpp のSetDrawColor()実装確認
3. **MEDIUM**: グリフアトラスのサイズと容量確認
4. **MEDIUM**: テクスチャレイヤーインデックス確認
5. **LOW**: Metalデバッガーでフレームキャプチャ

---

## 次回の計画書で実装すべき内容

調査結果に基づいて、以下のいずれかの修正を実装：

### パターンA: SetDrawColor()のアルファ値修正
- sg_draw.cpp でデフォルトアルファ値を1.0に設定
- または visual_test.lua で明示的にアルファ値を指定

### パターンB: グリフアトラス容量拡張
- ATLAS_WIDTH/ATLAS_HEIGHT を拡大
- または動的なアトラス拡張を実装

### パターンC: テクスチャレイヤー割り当て修正
- グリフアトラスと通常テクスチャのレイヤー分離
- フラグメントシェーダーでレイヤーインデックスを正しく処理

---

**状態**: 調査フェーズ - 次のステップは visual_test.lua と sg_draw.cpp の確認
