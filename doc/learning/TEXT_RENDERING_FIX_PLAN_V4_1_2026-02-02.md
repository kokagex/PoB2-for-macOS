# テキストレンダリング修正計画 V4.1

**日付**: 2026-02-02 07:30
**状態**: Phase 3 - 計画立案（V4の修正）
**前回の試行**: V4 Phase A - Debug Modification A（部分的成功、問題発見）

---

## V4 Phase A からの学習

### 実施内容

1. ✅ Debug Modification A を metal_backend.mm に適用
2. ✅ リビルド完了（07:19）
3. ✅ デプロイ完了（07:21）- 最初 dev/runtime を見落とし、後で修正
4. ✅ 視覚的テスト実行（3回）

### 視覚的結果

**スクリーンショット**: 2026-02-02 7.21.59.png

**観察**:
- **オレンジ/黄色のテキスト**: "below, the fix works!"
- **緑色のテキスト**: "Image rendering: (ring.png below)"

### Debug Modification A の期待

```metal
if (texColor.a < 0.01) {
    return float4(1.0, 0.0, 0.0, 1.0);  // RED
} else {
    return float4(0.0, 1.0, 0.0, texColor.a);  // GREEN with alpha
}
```

**期待される結果**: すべてのピクセルが**赤または緑**

**実際の結果**: オレンジ/黄色（赤 + 緑の混合？）+ 緑

---

## 根本原因分析

### 決定的な問題: アルファ値の影響

Debug Modification A の現在のコード:
```metal
return float4(0.0, 1.0, 0.0, texColor.a);  // GREEN with texColor.a
```

**問題**: `texColor.a` を保持しているため、半透明の緑が返される

**アルファブレンディングの影響**:
- Fragment出力: `(0.0, 1.0, 0.0, 0.5)` （アルファ0.5の緑）
- ブレンディング有効（metal_backend.mm lines 250-256）
- 背景色との混合が発生

**オレンジ/黄色の説明**:
複数の可能性があるが、最も単純な解決策は**完全不透明な色を使用**すること。

---

## V4.1の修正: Debug Modification A.1

### 修正内容

**metal_backend.mm line 122 を変更**:

```metal
// Before (V4)
return float4(0.0, 1.0, 0.0, texColor.a);  // 半透明の可能性

// After (V4.1)
return float4(0.0, 1.0, 0.0, 1.0);  // 完全不透明の緑
```

**理由**:
- 完全不透明 (alpha=1.0) にすることで、ブレンディングの影響を排除
- すべてのテキストが**純粋な赤または純粋な緑**になるはず
- 視覚的結果がより明確

**期待される結果**:
- テクスチャアルファ < 0.01 → **完全不透明の赤**
- テクスチャアルファ >= 0.01 → **完全不透明の緑**
- オレンジ/黄色のテキストは消えるはず

---

## 実装プラン

### ステップ1: Debug Modification A.1 を適用

**Artisan タスク**:
1. `pob2macos/dev/simplegraphic/src/backend/metal/metal_backend.mm` line 122 を修正
2. リビルド: `cd pob2macos/dev/simplegraphic && make -C build`
3. デプロイ（両方の場所）:
   ```bash
   cp build/libSimpleGraphic.dylib ../runtime/
   cp build/libSimpleGraphic.dylib ../PathOfBuilding.app/Contents/Resources/pob2macos/runtime/
   ```

**タイムボックス**: 5分

---

### ステップ2: 視覚的検証

**Paladin タスク**:
1. `cd pob2macos/dev && luajit visual_test.lua` 実行
2. スクリーンショット撮影を神に依頼
3. 結果分析

**期待される結果パターン**:

**ケースA: すべてのテキストが純粋な赤または純粋な緑**
- ✅ Debug Mod A.1 成功
- ✅ ブレンディング問題解決
- → Phase B に進む

**ケースB: すべてのテキストが赤**
- テクスチャアルファがすべて < 0.01
- テクスチャ更新が失敗している可能性
- → テクスチャ更新コードを調査

**ケースC: すべてのテキストが緑**
- テクスチャアルファがすべて >= 0.01
- テクスチャサンプリング成功
- → Debug Modification D（頂点カラー検証）に進む

**ケースD: まだオレンジ/黄色が表示**
- Debug Mod A.1 が適用されていない
- シェーダーコンパイルエラーまたはキャッシュ問題
- → 初期化ログ確認、完全リビルド

**タイムボックス**: 5分

---

### ステップ3: 結果に基づいた次ステップ決定

**Mayor タスク**:
結果に基づいて Phase B の方針を決定

**タイムボックス**: 5分

---

## タイムライン

- ステップ1: 修正・リビルド・デプロイ（5分）
- ステップ2: 視覚的検証（5分）
- ステップ3: 結果分析・次ステップ決定（5分）
- **合計: 約15分**

---

## リスク評価

### リスク1: 色が変わらない（オレンジ/黄色のまま）

**影響**: MEDIUM
**原因**: シェーダーキャッシュ、コンパイルエラー
**対策**:
- 初期化ログでコンパイルエラーを確認
- 完全リビルド: `rm -rf build && cmake -B build && make -C build`
- dylib タイムスタンプ確認

**ロールバック**: 簡単（git管理下）

---

### リスク2: アプリがクラッシュ

**影響**: LOW
**原因**: シェーダーコンパイルエラー
**対策**: ログ確認、元のシェーダーに戻す

**ロールバック**: 簡単（git管理下）

---

### リスク3: 15分で解決しない

**影響**: LOW
**対策**: タイムボックス厳守、ユーザーに状況報告、別のアプローチ検討

---

## 成功基準

### V4.1 成功基準

1. ✅ すべてのテキストが**純粋な赤または純粋な緑**（完全不透明）
2. ✅ オレンジ/黄色のテキストが消える
3. ✅ スクリーンショットで確認
4. ✅ 視覚的結果が明確で解釈しやすい

### 調査成功基準

1. ✅ Fragment Shader のデバッグ出力が正しく機能
2. ✅ テクスチャアルファの状態を確認
3. ✅ 次のデバッグ修正（Phase B）の方針を決定

---

## CRITICAL LESSONS の適用

### ルール1: ログは参考、視覚的結果が真実

**適用**: オレンジ/黄色のテキストという視覚的結果から問題を特定し、修正を立案

### ルール2: 15分以内に視覚的検証

**適用**: V4.1 全体で15分タイムボックス、各ステップ5分

### ルール5: 視覚的変化がなければ失敗と認める

**適用**: ステップ2で色が変わらなければ即座に失敗と認め、ステップ3で別のアプローチを検討

---

**状態**: Phase 3 完了 - Phase 4（レビュー）に進む
