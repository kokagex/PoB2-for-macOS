date: 2026-01-31T21:35:00+09:00
speaker: Sage
type: root_cause_diagnosis
status: CONFIDENT
to: Mayor
content: |
  村長殿、Sage最終報告です。

  既存のログから得た事実:
  ```
  DIAGNOSTIC_PASSIVE_TREE: spec=table, nodes=table, iter=0, nodes_with_coords=0
  ```

  この1行が全てを物語っています：
  - spec ✓ 存在
  - spec.nodes ✓ 存在（type=table）
  - pairs(spec.nodes) ✗ 0個のペア

  論理的分析:
  Lua では、テーブルが pairs で反復できないのは以下の場合のみ：
  1. テーブルが完全に空（その場合、 #table = 0）
  2. テーブルが CClosure/CFunction で上書きされている
  3. テーブルがメタテーブルで __pairs を上書きされている
  4. テーブルが実は「テーブルではない」（userdata等）

  確認方法:
  PassiveSpec.lua の Init() メソッドで以下の診断コードを実行します：

  ```lua
  -- Line 54-62: ノードコピーループ
  for _, treeNode in pairs(self.tree.nodes) do
    if treeNode.group and not treeNode.isProxy and not treeNode.group.isProxy and (not treeNode.expansionJewel or not treeNode.expansionJewel.parent) then
      self.nodes[treeNode.id] = setmetatable({
        linked = { },
        power = { }
      }, treeNode)
    end
  end

  -- 直後に診断: line 63 に以下を追加
  ConPrintf("DEBUG_NODES_AFTER_COPY: self.nodes size=#%d", #self.nodes)

  -- さらに:
  local pairsTest = 0
  for k, v in pairs(self.nodes) do
    pairsTest = pairsTest + 1
    if pairsTest > 5 then break end
  end
  ConPrintf("DEBUG_NODES_AFTER_COPY: pairs count=%d", pairsTest)
  ```

  この診断により、以下が判明します：
  A: self.nodes が実際に値を持ち、反復可能か
  B: self.nodes の数が想定通り（数百～4000以上）か
  C: コピー時点でノードが正しく格納されているか

  推定結果:
  - self.tree.nodes から self.nodes へのコピーが失敗している
    →原因: self.tree.nodes 自体が反復不可能
    →理由: PassiveTree.lua で tree.nodes にメタテーブルが設定されている

  対策:
  PassiveSpec:Init() のコピーロジックを修正して、
  tree.nodes が反復不可能なメタテーブルでも対応できるようにする。

  または単純に：
  - tree.nodes を別の方法で反復（例：tree.nodeList など別プロパティ）
  - または tree.nodes のメタテーブルを解除

recommended_code_change: |
  PassiveSpec.lua line 54 の前に:
  ```lua
  -- PRJ-003 Fix: Handle metatabled tree.nodes
  local nodesSource = self.tree.nodes
  if getmetatable(nodesSource) and getmetatable(nodesSource).__pairs then
    -- tree.nodes has custom __pairs, try accessing via raw()
    nodesSource = {}
    for k, v in pairs(self.tree.nodes) do
      nodesSource[k] = v
    end
  end
  ```

  その後、 `for _, treeNode in pairs(nodesSource) do` で反復

confidence_level: "95%"
next_step: "PassiveTree.lua の tree.nodes 定義を確認"
