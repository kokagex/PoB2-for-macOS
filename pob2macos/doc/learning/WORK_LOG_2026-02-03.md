# Codex Work Log (2026-02-03)

## Overall Status
- All work so far failed (no successful visual window or test completion achieved).

## Failures
- `./dev/pob2_launch.lua` and `./PathOfBuilding.app/Contents/Resources/pob2macos/pob2_launch.lua` failed with missing `runtime/SimpleGraphic.dylib` when run from `pob2macos`.
- After linking runtime, `dev/visual_test_20sec.lua` ran but no window appeared for the user. Logs showed macOS `hiservices-xpcservice` connection invalid errors during SimpleGraphic init.

## Changes Applied
- Added symlink: `pob2macos/runtime` -> `dev/runtime` (so `runtime/SimpleGraphic.dylib` resolves).
- Added symlink: `PathOfBuilding.app/Contents/Resources/pob2macos/TreeData` -> `dev/pob2-original/src/TreeData`.
- Added symlink: `PathOfBuilding.app/Contents/Resources/pob2macos/Assets` -> `.../src/Assets`.
- Added symlink: `PathOfBuilding.app/Contents/Resources/pob2macos/Data` -> `.../src/Data`.
- Added symlink: `PathOfBuilding.app/Contents/Resources/pob2macos/runtime/lua` -> `dev/runtime/lua`.

## Code Changes (Minimal Passive Tree Test Support)
- `pob2macos/PathOfBuilding.app/Contents/Resources/pob2macos/src/Classes/PassiveSpec.lua`
- `pob2macos/PathOfBuilding.app/Contents/Resources/pob2macos/src/Classes/PassiveTree.lua`
- `pob2macos/PathOfBuilding.app/Contents/Resources/pob2macos/src/Classes/PassiveTreeView.lua`

Summary of edits:
- Guarded class/ascendancy selection when `_G.MINIMAL_PASSIVE_TEST` is set.
- Made orbit angles optional by computing fallback angles.
- Loaded assets from `TreeData/3_19/Assets` when missing, and adjusted `LoadImage` to handle nil and fallback paths.
- Ensured `nodeOverlay` exists and skipped `ProcessStats` when in minimal test mode.
- Added nil checks around `node.overlay` in tree view draw paths.

## Latest Status Update
- Text-only test still flickers across the entire text area even when drawing only once every 10 frames.
- This indicates flicker is not caused by changing text content each frame.
- Suspect causes now include glyph atlas updates or present/swap timing issues.


## Latest Status Update (Glyph Atlas Logging)
- Added `ATLAS-UPDATE` logging in `dev/simplegraphic/src/rendering/sg_text.cpp`.
- Logs show atlas updates on frame 1 and **glyph count resets starting frame 2**, suggesting atlas recreation each frame.
- This behavior likely causes persistent flicker even when text content is static.


## Latest Status Update (Flicker Unchanged)
- User reports full-screen flicker persists; text still not readable.
- Latest screenshot shows no visible text despite running text-only test.
- Indicates atlas/present issue still unresolved.


## Latest Status Update (Throttled Text Draw)
- User reports full-screen flicker persists; latest screenshot shows no visible text.
- Current test draws text only every 10 frames, which inherently causes blinking.
- Next step: run a control test with a single large text line drawn every frame.


## Latest Status Update (Mixed Size Flicker)
- Mixed large+small text causes flicker; small line visible while large line may disappear intermittently.
- Strong evidence that size mixing is the trigger; next step is small-only control.


## Learning Summary
- Rendering pipeline works for images and large text after removing the forced magenta shader.
- Flicker correlates with small glyph sizes or mixed-size text; large-only text is stable.
- Font cache misses are not repeating; issue is likely in atlas update or present timing for small glyphs.


## Latest Status Update (Shared Storage)
- Changed Metal textures to `MTLStorageModeShared` and rebuilt.
- Flicker persists in mixed-size text test; change did not resolve issue.


## Latest Status Update (Small Text Scaling Fix)
- Implemented scaling: small text now rasterizes at 64px and scales down during draw.
- Rebuilt and deployed SimpleGraphic dylib.
- Next step: rerun mixed-size test to verify flicker reduction.


## Latest Status Update (Flicker Fixed)
- Mixed-size text now renders without flicker after scaling small text from 64px base.
- Screenshot confirms stable large + small text.

- 18:?? Started passive tree test after disabling Background2 draw (to isolate top-left flicker). Awaiting screenshot/user confirmation.
- 19:18 Started passive tree test after disabling Background2 draw (to isolate top-left flicker). Awaiting screenshot/user confirmation.
- 19:21 Debug change: return early after drawing only PSSkillFrame (debugOnlySingleAsset=true) to isolate flicker. Next: run passive tree test.
- 19:26 Debug change: replaced single-asset draw with solid magenta rectangle (DrawImage(nil)) when debugOnlySingleAsset=true to isolate texture flicker. Next: run passive tree test.
- 19:32 Debug change: moved solid-rectangle-only early return to the top of PassiveTreeView:Draw (before any text/asset draws). This isolates flicker to core image draw path only.
- 19:33 Debug stage switch: now text-only (DrawString 'TEXT ONLY') with early return. Solid/texture flags off. Next: run passive tree test.
- 19:34 Debug stage switch: text-only was stable. Now texture-only (PSSkillFrame) enabled with early return. Next: run passive tree test.
- 19:37 Fix attempt: removed DIAG-BYPASS immediate draws in metal_draw_image; rebuilt SimpleGraphic dylib and copied to dev/runtime. Switched debugOnlySingleAsset default to false (full render). Running passive tree test next.
- 19:39 Flicker persists in full render. Fix attempt: implemented triple-buffered vertex buffers + in-flight semaphore in metal_backend.mm to avoid CPU overwriting GPU buffers. Rebuilt and copied SimpleGraphic dylib.
- 19:43 Fix attempt: prevent mid-frame vertex overwrite by appending batches (batchStart) and increasing vertex buffer size to 200k. Added overflow guards. Rebuilt and deployed SimpleGraphic.dylib.
- 19:46 Crash found in luajit completion handler: dispatch_semaphore_signal on Metal completion queue. Fix: capture semaphore locally in addCompletedHandler to avoid use-after-free of MetalContext. Rebuilt and deployed SimpleGraphic.dylib. Running passive tree test next.
- 19:47 Result: Flicker resolved, images display, no crash after semaphore capture fix. Screenshot saved on desktop (user confirmed).
- 19:48 Restored normal rendering: removed debug-only early return, removed debug overlays (center marker/node markers/test asset), and re-enabled Background2 draw.
- 19:56 Cleanup: removed PassiveTreeView debug logging/overlays/asset logs; removed PassiveTree debug load/count logs; disabled draw param test in dev/pob2_launch.lua. Reduced Metal/SG debug spam via SG_DIAG_LOG and removed frame loop debug prints. Rebuilt and redeployed SimpleGraphic.dylib.
- 19:58 User requested additional tests (zoom/pan/hover) after stabilization. Launching passive tree test.
- 20:00 Extended passive tree test duration to 3600 frames (~60s) in Launch.lua for verification.
- 20:03 Added minimal inputEvents generation in Launch.lua (edge-triggered LEFT/RIGHT buttons, PAGEUP/PAGEDOWN, UP/DOWN->WHEELUP/WHEELDOWN) so zoom/pan works in passive tree test.
- 20:11 Input fixes: added scroll callback + GetMouseWheelDelta API; added sg_input_update polling to prevent stuck mouse buttons; Launch.lua now emits WHEELUP/WHEELDOWN from mouse wheel. Rebuilt and deployed SimpleGraphic.dylib.
- 20:13 Fix: exposed GetMouseWheelDelta to Lua in dev/pob2_launch.lua to prevent nil call. Retest required.
- 20:15 Fix: added GetMouseWheelDelta FFI + Lua wrapper to app bundle pob2_launch.lua (the script used by run_passive_tree_test). Retesting.
- 20:18 Input fix v2: sg_input_update clears mouse buttons when window not focused; GetMouseWheelDelta now returns +/-1 for fractional scroll to support trackpad/scroll wheels. Rebuilt and deployed SimpleGraphic.dylib.
- 20:23 Fix: app bundle runtime SimpleGraphic.dylib was outdated. Copied latest libSimpleGraphic.dylib into PathOfBuilding.app/Contents/Resources/pob2macos/runtime/ (both SimpleGraphic.dylib and libSimpleGraphic.dylib). Retesting wheel/click.
- 20:56 Input fix v3: sg_input_update now clears mouse buttons and scroll when window not focused or cursor not hovered. GetMouseWheelDelta now consumes fractional scroll without oscillation (clears remainder). Rebuilt and redeployed SimpleGraphic.dylib.
- 20:57 Passive tree Launch.lua: removed arrow-key zoom fallback, added on-screen input diagnostics (LB/RB/ALT/Wheel/Cursor) to verify stuck mouse/scroll behavior.
- 21:02 Launched passive tree test via codex/run_passive_tree_test.command (GUI). Awaiting user input diagnostics overlay values.
- 21:07 Input fix v4: sg_input_update now also clears SHIFT/CTRL/ALT states when window not focused or cursor not hovered. Rebuilt and deployed SimpleGraphic.dylib.
- 21:08 Launch.lua overlay expanded: shows SHIFT/CTRL state, drag status (DRAG), mOver, cursor, and drag origin (DX/DY) for diagnosing pan persistence and zoom suppression.
- 21:11 Relaunched passive tree test (run_passive_tree_test.command) with expanded input overlay.
- 21:19 Harness fix: Launch.lua now force-clears drag state when LB is up, and applies direct zoom on wheel delta (bypasses inputEvents). Intended to stop persistent pan and restore zoom in passive tree test.
- 21:20 Relaunched passive tree test after harness zoom/drag fixes.
- 21:23 User confirmed: pan now stops correctly and zoom works after harness fixes (drag force-clear + direct zoom on wheel).
- 21:34 Replaced harness-specific input hacks with proper input event polling in pob2_launch.lua (app + dev). Polls IsKeyDown edges, dispatches OnKeyDown/OnKeyUp, handles wheel as KeyUp, and double-click detection.
- 21:34 Passive tree Launch.lua now uses OnKeyDown/OnKeyUp to build inputEvents; removed direct zoom/drag workarounds and debug overlay.
- 21:36 Relaunched passive tree test after moving to proper input event pipeline (no harness hacks).
- 21:44 Input fix v5: IsKeyDown now queries GLFW mouse buttons directly for LEFT/RIGHT/MIDDLE (avoids stale mouse states). Rebuilt and redeployed SimpleGraphic.dylib.
- 21:45 Relaunched passive tree test after IsKeyDown mouse direct polling fix.
- 21:52 Input fix v6: removed GLFW_HOVERED early-return (was clearing scroll), and IsKeyDown now treats mouse as up when cursor is outside window bounds or window not focused. Rebuilt and redeployed SimpleGraphic.dylib.
- 21:53 Relaunched passive tree test after IsKeyDown cursor-bounds guard and hover-clear removal.
- 21:59 Input fix v7: explicitly disabled GLFW sticky keys and sticky mouse buttons in sg_window_init to avoid stuck press states. Rebuilt and redeployed SimpleGraphic.dylib.
- 22:00 Relaunched passive tree test after disabling GLFW sticky input modes.
- 22:09 Input fix v8: restored IsKeyDown to use ctx->keys; sg_input_update now force-releases mouse buttons when cursor not hovered (without clearing scroll). Rebuilt and redeployed SimpleGraphic.dylib.
- 22:10 Relaunched passive tree test after hover-based mouse release restoration.
- 22:15 Relaunched passive tree test on user request (user was away; needs recheck).
- 22:23 Removed ALT gating for WHEELUP/WHEELDOWN zoom in app PassiveTreeView to match original behavior and avoid alt-stuck blocking zoom.
- 22:24 Relaunched passive tree test after removing ALT zoom gate.
- 22:31 Wheel smoothing: pob2_launch.lua (app + dev) now accumulates wheel delta and emits at most one WHEELUP/WHEELDOWN per frame to prevent excessive zoom steps.
- 22:32 Relaunched passive tree test after wheel smoothing change.
- 22:38 PassiveTreeView wheel zoom step reduced to 0.1 (shift 0.3) in app + dev source to achieve ~1/10 zoom rate.
- 22:39 Relaunched passive tree test after reducing wheel zoom step.
- 22:42 Tried open PathOfBuilding.app for real Tree tab check; failed because app executable is missing.
- 22:51 Restored missing app bundle executable by creating Contents/MacOS/PathOfBuilding launcher script (luajit -> pob2_launch.lua) and added minimal Contents/Info.plist.
- 22:52 Launched PathOfBuilding.app after restoring executable/Info.plist.
- 23:04 Implemented sprite-sheet loading from tree.sprites for local skills-3.jpg (node icons). Added asset mapping via UV coords. Launched passive tree test for verification.
- 21:58 Reworked sprite-sheet loading to build spriteMap by sprite type (normalActive, etc.) using local skills-*.jpg; added robust zoom selection and sprite sheet path resolution.
- 21:58 ProcessNode now assigns node.sprites (and masterySprites for mastery nodes) from spriteMap with MasteryBlank fallback.
- 21:58 PassiveTreeView now draws node icons via node.sprites (state-aware) and adds mastery sprite selection logic (override + active/connected/inactive).
- 21:59 User reports no visual change; current node icons still show same pattern. User confirmed the referenced images are PoB1 assets; need PoB2 Windows assets (PathOfBuilding-PoE2) for correct node icons.
- 22:22 Pulled PoE2 Windows assets: copied TreeData/0_1..0_4 from /Users/kokage/Downloads/PathOfBuilding-PoE2-dev into app resources.
- 22:22 Added PoE2 GameVersions.lua and Modules/Common.lua into app src to load PoE2 tree versions.
- 22:22 PassiveTree.lua now loads assets from tree.lua (data[1]) and no longer builds PoE1 spriteMap; LoadImage sets data.found flag.
- 22:22 PassiveTreeView.lua reverted node icon selection to PoE2 logic (tree:GetAssetByName(node.icon)).
- 22:22 Launch.lua jewel radii updated to PoE2 0_1 values for minimal test harness.
- 22:33 Attempted passive tree test run after PoE2 asset switch; process timed out at 120s and log stopped after SimpleGraphic init (macOS LaunchServices warnings). No DDS load counts captured.
- 22:45 Fixed texture-array layer sampling: DrawImage now treats single tcLeft as layer index (tcTop/Right/Bottom=0) in pob2_launch.lua.
- 22:45 Adjusted PoE2 ddsCoords layer indices to 0-based when building ddsMap in PassiveTree.lua.
- 22:50 PassiveTreeView DrawAsset scaled down to PoE2 behavior (removed 1.33 multiplier) to correct icon alignment.
- 22:54 Launch.lua now sets window title to include latestTreeVersion to help confirm PoE2 tree version in test window.
- 23:22 Updated DrawImage wrapper to ignore non-numeric tcLeft (e.g., filename strings) and fall back to default UVs; prevents accidental UV/layer usage when assets are passed via unpack().
- 23:32 Added F2 toggle to show a debug crosshair at hovered node center and display hover id/icon; helps diagnose icon alignment issues.
- 23:40 Updated debug toggle to accept key "D" in addition to F2 (for keyboards without function keys).
- 23:45 Debug toggle key fixed to lowercase "d" (input events send lowercase a-z).
- 23:53 Made debug crosshair always-on by default; now draws at nearest node to cursor (not only hover) and shows nearest node id/icon text. This avoids relying on hover detection when icons are misaligned.
- 23:58 Enlarged debug crosshair and text size for visibility.
- 00:02 Added debug overlays for nearest node: red center cross, magenta base icon bounding box, green overlay bounding box, cyan marker at icon top-left. Helps visualize per-icon offset differences.
- 00:09 Fixed DDS array layer sizing to include full mip chain (prevents wrong layer offsets) in dev/simplegraphic/src/utilities/dds_loader.c; rebuilt SimpleGraphic and copied updated lib to app runtime.
- 00:14 Fixed cursor coordinate scaling for Retina: GetCursorPos now multiplies by DPI scale to return framebuffer-space coordinates. Rebuilt SimpleGraphic and updated runtime dylibs.
- 00:19 Fixed hover detection to use spec.nodes (not tree.nodes) so hover/selection state matches rendered nodes.
- 00:24 Added hover fallback: if rsq test fails, use nearest node within size radius for hover/click response.
- 00:27 Added screen-space nearest-node detection and hover fallback within 70px; debug text now shows hover id, nearest id, and pixel distance.
- 00:31 Enabled full passive tree interactions by disabling MINIMAL_PASSIVE_TEST and added empty items/sockets tables to itemsTab.
- 00:37 Added OnInit progress logs around PassiveSpec/PassiveTreeView creation to diagnose startup hang.
- 06:36 Test app stopped starting after MINIMAL_PASSIVE_TEST=false change; log stalled after RenderInit.
- 06:40 Launch.lua: reverted to MINIMAL_PASSIVE_TEST=true; preloaded tree with MINIMAL=false just for modList creation; then allocate a valid class start node and call BuildAllDependsAndPaths so hover/pathing works in minimal mode without full app deps.
- 06:48 Added run timestamps + append mode to codex/run_passive_tree_test.command to confirm actual run and preserve history.
- 06:49 Added logging to app launcher (Contents/MacOS/PathOfBuilding) to write to codex/passive_tree_app.log with run timestamp.
- 06:56 Launch.lua: removed MINIMAL=false tree preload (modLib missing); added emptyModList stub and assigns it to all nodes before BuildAllDependsAndPaths so pathing works in minimal mode without ModList/modLib.
- 07:02 Launch.lua: empty ModList stub now includes Sum() and More() (Sum->0, More->1) to prevent PassiveTreeView crash on SmallPassiveSkillEffect calculation.
- 07:08 PassiveTreeView.lua: increased debug text size to 8x (18 -> 144) for hover/nearest display.
- 07:12 PassiveTreeView.lua: adjusted debug text size to 48 to avoid clipping.
- 07:15 PassiveTreeView.lua: moved debug text down by 100px to avoid double overlap at top-left.
- 07:21 PassiveTreeView.lua: in MINIMAL_PASSIVE_TEST, do not clear hoverNode when path is missing; allows hover highlight/tooltip even without pathing.
- 07:28 PassiveTreeView.lua: guard traceMode path initialization when hoverNode.path is nil to avoid ipairs crash in minimal mode.
- 07:36 PassiveTreeView.lua: added minimal-mode hover fallback (nearest node within 120px) to force hover when rsq/path logic fails.
- 07:44 PassiveTreeView.lua: replaced fixed hover fallback radius with dynamic radius based on node size * scale (clamped 40..160) to improve hover image response.
- 08:02 PassiveSpec.lua: added minimal ModList stub helper; minimal SelectClass/SelectAscendClass now allocates start nodes and calls BuildAllDependsAndPaths for class/ascendancy switching without modLib; ReplaceNode skips ModList creation in minimal.
- 08:03 Launch.lua: added main:SetWindowTitleSubtext stub and build.buildName to avoid title update errors during class/ascendancy switching.
