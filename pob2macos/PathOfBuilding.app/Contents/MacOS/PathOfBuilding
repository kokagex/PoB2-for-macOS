#!/bin/bash
# Path of Building for macOS - Shell Launcher
# Compatible with all macOS versions

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

# App bundle paths
APP_ROOT="${SCRIPT_DIR}/../../"
POB_ROOT="${APP_ROOT}/Contents/Resources/pob2macos"
LUAJIT_PATH="/usr/local/bin/luajit"

# Check if LuaJIT is installed
if [ ! -x "${LUAJIT_PATH}" ]; then
    # Try to find luajit in PATH
    if command -v luajit &> /dev/null; then
        LUAJIT_PATH=$(command -v luajit)
    else
        osascript -e 'display dialog "LuaJIT is not installed.\n\nPlease install it using:\nbrew install luajit" buttons {"OK"} default button "OK" with icon stop with title "Path of Building"'
        exit 1
    fi
fi

# Change to pob2macos directory
cd "${POB_ROOT}" || {
    osascript -e 'display dialog "Failed to find Path of Building resources.\n\nPlease reinstall the application." buttons {"OK"} default button "OK" with icon stop with title "Path of Building"'
    exit 1
}

# Set log file
LOG_FILE="${HOME}/Library/Logs/PathOfBuilding.log"
mkdir -p "$(dirname "${LOG_FILE}")"

# Launch Path of Building
echo "==================================" > "${LOG_FILE}"
echo "  Path of Building 2 for macOS" >> "${LOG_FILE}"
echo "==================================" >> "${LOG_FILE}"
echo "" >> "${LOG_FILE}"
echo "Starting at: $(date)" >> "${LOG_FILE}"
echo "Working directory: ${POB_ROOT}" >> "${LOG_FILE}"
echo "LuaJIT: ${LUAJIT_PATH}" >> "${LOG_FILE}"
echo "" >> "${LOG_FILE}"

# Execute with output to log
"${LUAJIT_PATH}" pob2_launch.lua >> "${LOG_FILE}" 2>&1

# Log exit status
EXIT_CODE=$?
echo "" >> "${LOG_FILE}"
echo "Exited with code: ${EXIT_CODE} at $(date)" >> "${LOG_FILE}"

exit ${EXIT_CODE}
