# AGENT.md - サブエージェント運用・トラブルシューティング

## Lua修正サブエージェント

### 基本パターン
```
Task tool → subagent_type: "general-purpose"
```

### 渡す情報
1. ファイルパス（絶対パス）
2. 変更箇所（行番号）
3. 変更内容（具体的な修正コード）
4. 周辺コードのコンテキスト（前後10行程度）
5. LuaJIT 5.1制約の注意点

### コンテキスト制限
- サブタスクは**50%未満**のコンテキストで完了できるよう分割
- 大きな変更は複数のサブエージェントに分割

### Lua固有の注意点
- LuaJIT 5.1（NOT Lua 5.4）
- nil-safety必須（チェーンアクセス前に検証）
- `ConPrintf`は`%s` + `tostring()`のみ（`%d`禁止）
- `newClass()`はグローバル登録が必要: `_G.ClassName = ClassTable`
- `table.insert()` 推奨（`table.move()` 不可）

### ファイル同期の指示
サブエージェントには必ず以下を指示:
- `src/`の修正後、アプリバンドルにもコピーすること
- パス: `PathOfBuilding.app/Contents/Resources/pob2macos/src/`

---

## スキルベース・サブエージェント設計

### 原則: プログレッシブ開示
汎用エージェントではなく、機能固有のサブエージェントを作成する。

### パターン
| タスク種別 | サブエージェント設計 |
|-----------|-------------------|
| Lua修正 | ファイルパス+行番号+修正内容を明示 |
| コード探索 | `subagent_type: "Explore"` |
| プラン作成 | `subagent_type: "Plan"` |
| ビルド実行 | `subagent_type: "Bash"` + バックグラウンド |

### 悪いパターン（避けるべき）
- 「このファイル全体を見て問題を見つけて」→ 範囲が広すぎる
- 「このバグを直して」→ コンテキスト不足
- 複数ファイルの同時修正を1つのサブエージェントに依頼

### 良いパターン
- 「Build.lua:245行目の`self.controls`のnil checkを追加。周辺コード: [貼り付け]」
- 「PassiveTree.lua:440行目の`and`を`or`に変更。理由: ClassStart接続修正」

---

## トラブルシューティング

### サブエージェントが失敗する場合
1. **コンテキスト不足**: 周辺コードを追加で渡す
2. **LuaJIT互換性エラー**: Lua 5.2+機能を使っていないか確認
3. **ファイルパスエラー**: 絶対パスを使用しているか確認
4. **Edit失敗**: `old_string`がユニークか確認、より多くのコンテキストを含める

### バックグラウンドタスクの管理
```
run_in_background: true → TaskOutput で定期確認
```
- ビルドコマンドは `timeout: 300000`（5分）を設定
- ログが見えない場合は `tail` でoutput_fileを確認

### コンテキスト溢れ防止
- `/compact` はコンテキスト使用率 **50%** で実行
- 探索結果が大きい場合はサブエージェントに委譲
- 不要な出力は `head_limit` で制限
