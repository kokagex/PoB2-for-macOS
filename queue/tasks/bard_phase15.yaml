# Phase 15 Task Assignment - BARD (吟遊詩人)
# Documentation & Production Readiness
# Issued: 2026-01-29T22:30:00Z

project: PRJ-003 PoB2macOS
phase: Phase 15 - Architectural Refinement & Production Readiness
agent: Bard (吟遊詩人)
status: ASSIGNED (BLOCKED until Artisan A4 complete)
issued_by: Mayor (村長)
issued_at: "2026-01-29T22:30:00Z"

authority: Bard is knowledge preservation guardian - ensures documentation complete and accessible

---

## Overall Task Summary

**Total Estimated Time**: 9.5 hours
**Blockers**: Can start after Artisan A4 complete (documentation independent of code)
**Parallelization**: B1/B2/B3/B4 can parallel, finalize after testing complete
**Quality Gate**: 100+ pages comprehensive documentation, production-ready

---

## Task B1: Production Deployment Guide (3 hours)

**Deliverable**: `/Users/kokage/national-operations/claudecode01/memory/PHASE15_DEPLOYMENT_GUIDE.md`

**Description**: Comprehensive deployment documentation for production environments and end users.

### Target Audience:
- System administrators deploying to macOS systems
- End users installing PoB2macOS
- Support teams troubleshooting issues

### Document Length Target: 50+ pages

### Section 1: System Requirements (5 pages)

**Minimum macOS Version**
- macOS Catalina 10.15+ recommended
- Monterey (12.x) or later preferred
- Rationale for version requirements

**CPU Requirements**
- Required: x86_64 architecture
- Recommended: SSE 4.1 support (all modern Intel)
- Optional: AVX support (not required)
- Apple Silicon: M-series support (if applicable)

**RAM Requirements**
- Minimum: 4 GB
- Recommended: 8 GB or more
- Rationale: Peak memory usage scenarios

**Disk Space**
- Installation: 500 MB (including all dependencies)
- Runtime data: 1-2 GB (passive trees, item databases)
- Cache: 500 MB (temporary files, cleared on exit)

**Network Requirements**
- Optional: internet connectivity for PoE2 updates
- Not required for local builds, but recommended

**GPU Requirements**
- Integrated GPU sufficient (Intel HD Graphics, M-series GPU)
- Dedicated GPU not required but supported
- OpenGL 3.2+ support required

### Section 2: Installation (10 pages)

**Pre-Built Binaries** (if available)
- Download link and instructions
- Signature verification (if signed)
- Installation to /Applications/

**From-Source Build**
- Prerequisites: git, cmake, homebrew, clang
- Step-by-step build instructions
- Troubleshooting common build errors

**Dependency Installation**

| Dependency | Version | Method | Required |
|------------|---------|--------|----------|
| CMake | 3.16+ | brew install cmake | Yes |
| GLFW | 3.4+ | brew install glfw | Yes |
| FreeType | 2.12+ | brew install freetype | Yes |
| LuaJIT | 2.1.0 | brew install luajit | Yes |
| zstd | 1.5+ | brew install zstd | Yes |

**Path Configuration**
- Add PoB2 to PATH
- Create desktop shortcuts
- Symlink setup if needed

### Section 3: Configuration (8 pages)

**Configuration File Locations**
- ~/.pob2/config.lua (user config)
- /etc/pob2/ (system-wide config, if applicable)
- Precedence: user config > system config > defaults

**Environment Variables**
- LUA_PATH: Custom Lua module search paths
- POBJ_PATH: Path of Building JSON data location
- POBJ_CACHE_DIR: Temporary cache directory

**Performance Tuning**
- Thread count configuration
- Memory limits per sub-script
- Timeout configuration (30 seconds default)
- FPS cap (60 default, adjustable)

**Logging Configuration**
- Log level: DEBUG, INFO, WARN, ERROR
- Log file location: ~/.pob2/logs/
- Verbosity levels

### Section 4: First Run (5 pages)

**Initial Data Download**
- Passive tree download
- Unique item database download
- Expected download size (~100 MB)
- Progress indication

**First Launch Checklist**
- System prerequisites check
- Display capabilities check
- File permission verification
- UI responsiveness verification

**Benchmark Execution**
- Built-in performance test
- Expected results on different hardware
- Interpretation of results

**Feature Verification**
- Basic build creation workflow
- Sub-script execution test
- Save/load functionality test
- UI rendering test

### Section 5: Troubleshooting (10 pages)

**Common Issues & Solutions** (20+ issues)

| Issue | Symptom | Cause | Solution |
|-------|---------|-------|----------|
| Black window on startup | Window appears but no UI | OpenGL context failure | Check OpenGL drivers |
| Sub-scripts timeout | 30-second warning | Lua evaluation too slow | Increase timeout, simplify build |
| Memory spikes | Memory >1GB for simple build | Memory leak (Phase 15 fix) | Update to latest version |
| Crashes on startup | Segfault before UI | Dependency version mismatch | Verify dependency versions |
| No network connectivity | Update checks fail | Firewall blocking | Allow outbound port 443 |
| Slow UI responsiveness | Freezes during interactions | Sub-script executing | Normal, waits for completion |

**Log File Locations**
- ~/.pob2/logs/pob2macos.log (main log)
- ~/.pob2/logs/subscript_*.log (sub-script logs)
- System console output

**Debug Mode Activation**
- POBJ_DEBUG=1 environment variable
- Verbose logging output
- Performance metrics collection

**Known Limitations**
- DDS.zst texture format: only BC7 format fully supported
- Parallel sub-scripts: maximum 4 concurrent
- Build complexity: tested up to 500 passive points

### Section 6: Upgrade Path (5 pages)

**Backup Procedures**
- Backup user settings: ~/.pob2/
- Backup builds: ~/.pob2/builds/
- Automated backup before upgrade

**Version Compatibility**
- Phase 14 to Phase 15 upgrade: fully compatible
- Forward compatibility: N/A (latest version)
- Migration instructions if needed

**Rollback Procedures**
- Restore previous version
- Rollback settings if needed
- Emergency recovery procedures

### Section 7: Advanced Topics (8 pages)

**Custom Scripts and Plugins**
- Lua script loading mechanism
- API documentation
- Example custom scripts

**Performance Profiling**
- Using Instruments.app with PoB2
- Valgrind profiling (developers only)
- FPS monitoring and optimization

**Memory Management**
- Memory usage profiling
- Garbage collection tuning
- Out-of-memory handling

**Sub-Script Timeout Configuration**
- Timeout mechanism explanation
- Adjusting timeout duration
- Understanding timeout behavior

### Success Criteria:
- [ ] 50+ pages of clear, procedural documentation
- [ ] All system requirements fully specified
- [ ] Installation tested on clean macOS system
- [ ] Troubleshooting covers 20+ common issues
- [ ] Non-technical users can follow instructions
- [ ] Screenshots/diagrams included (5+ images)
- [ ] Accessibility: clear formatting, consistent terminology

---

## Task B2: Architecture & Internals Documentation (2.5 hours)

**Deliverable**: `/Users/kokage/national-operations/claudecode01/memory/PHASE15_ARCHITECTURE.md`

**Description**: Technical deep-dive for developers and maintainers.

### Target Audience:
- Software developers maintaining codebase
- Contributors adding features
- Architects planning future work

### Document Length Target: 40+ pages

### Section 1: Cooperative Shutdown Architecture (10 pages)

**Thread Lifecycle Diagrams**
- Worker thread creation (ASCII diagram)
- Normal execution flow
- Graceful shutdown flow
- Timeout abort flow

**Shutdown Sequence Diagrams** (timing diagrams)
```
Main Thread:                Worker Thread:
  set flag ──────────┐
                     ├──→ check flag
                     └──→ cleanup
                     └──→ exit
  pthread_join() ◄───── (waiting)
```

**Resource Cleanup Flow**
- Lua state allocation
- Lua state cleanup handlers
- Cleanup handler execution order
- Resource tracking updates

**State Machine** (runnable → shutdown_requested → cleanup → exit)
- State transitions
- Transitions table
- Invariants maintained

### Section 2: Lua State Management (8 pages)

**Multi-Threaded Isolation Strategy**
- Each worker thread: isolated Lua VM
- Lua state per thread (no sharing)
- Memory isolation between threads
- Why this design (correctness, safety)

**Cleanup Handler Chain**
- pthread_cleanup_push/pop ordering
- Handler registration timing
- Handler execution sequence
- lua_close() guarantees

**Resource Tracking Mechanism**
- Global resource counter
- Thread-safe access (mutex)
- Counter updates on create/free
- Metrics collection

**Lua Memory Management**
- Allocator hooks (if applicable)
- Garbage collection integration
- Memory limits per state
- Leak detection strategy

### Section 3: Timeout Watchdog Design (8 pages)

**Flag-Based Cancellation Mechanism**
- Volatile sig_atomic_t flag usage
- Why atomic operations needed
- Atomic variable memory ordering
- Correctness guarantees

**Signal Handling** (if using SIGUSR1)
- Signal handler implementation
- Async-signal-safe functions
- Signal delivery semantics
- Interruption of blocking calls

**Timeout Watchdog Thread**
- Watchdog thread main loop
- Timeout tracking per worker
- Flag-setting mechanism
- pthread_join() waiting

**Compared to pthread_cancel()**
- Old approach: undefined behavior
- New approach: cooperative shutdown
- Safety improvements
- Performance implications

### Section 4: Memory Safety Guarantees (8 pages)

**Proof of Leak-Freeness**
- Resource accounting verification
- Cleanup completeness analysis
- Valgrind test results integration
- Mathematical proof sketches

**ThreadSanitizer Compliance**
- No data races detected
- Synchronization validation
- Memory ordering correctness
- Test scenario coverage

**Valgrind Validation Results**
- Test scenario table
- Results for each scenario
- Leak reports (all zero)
- Conclusions

**CWE Coverage Resolution**
- CWE-401: Missing Release of Memory (RESOLVED)
- CWE-364: Signal Handler Race Condition (RESOLVED)
- CWE-366: Race Condition (RESOLVED)
- CWE-440: Expected Behavior Violation (RESOLVED)

### Section 5: Performance Characteristics (6 pages)

**Overhead Analysis**
- Flag checking cost: <1 microsecond per check
- Resource tracker overhead: <1%
- Cleanup handler cost: amortized
- Total per-timeout overhead: <5ms

**Scaling with Thread Count**
- Single worker: baseline
- 4 concurrent workers: linear scaling
- 16 concurrent workers: expected bottlenecks
- Recommendations for optimization

**Memory Growth Patterns**
- Per-worker Lua VM memory
- Shared resource tracker memory
- Cleanup verification memory
- Peak memory usage scenarios

**Startup/Shutdown Performance**
- Time to first sub-script launch
- Time to cleanup on timeout
- Batch operation efficiency
- Stress testing results

### Document Quality:
- [ ] 40+ pages technical documentation
- [ ] All major systems explained
- [ ] Diagrams and pseudocode included (10+ visuals)
- [ ] Suitable for future maintainers
- [ ] References to code locations (subscript_worker.c:line_number)
- [ ] Consistent terminology throughout

---

## Task B3: Phase 15 Completion Report (2.5 hours)

**Deliverable**: `/Users/kokage/national-operations/claudecode01/memory/PHASE15_COMPLETION_REPORT.md`

**Description**: Executive summary and final status of Phase 15.

### Document Length Target: 30+ pages

### Section 1: Phase 15 Objectives Summary (3 pages)

**CRITICAL-1 Resolution Status**
- Objective: Fix Lua state memory leak on pthread_cancel
- Solution: Cooperative shutdown + cleanup handlers
- Status: COMPLETE/IN PROGRESS/FAILED
- Evidence: Valgrind results, resource tracking metrics

**HIGH-2 Resolution Status**
- Objective: Eliminate undefined behavior in thread cancellation
- Solution: Flag-based cooperative shutdown (POSIX compliant)
- Status: COMPLETE/IN PROGRESS/FAILED
- Evidence: ThreadSanitizer results, POSIX audit

**Production Readiness Achievements**
- Deployment guide: complete
- Performance profiling: complete
- E2E user scenarios: all passing
- Security audit: passed
- Documentation: comprehensive

### Section 2: Quality Metrics (5 pages)

**Memory Safety** (Valgrind)
| Metric | Required | Result | Status |
|--------|----------|--------|--------|
| Definite leaks | 0 bytes | ? bytes | ✓/✗ |
| Possible leaks | 0 bytes | ? bytes | ✓/✗ |
| Invalid reads | 0 | ? | ✓/✗ |
| Invalid writes | 0 | ? | ✓/✗ |
| Peak memory | <600MB | ?MB | ✓/✗ |

**Thread Safety** (ThreadSanitizer)
| Metric | Required | Result | Status |
|--------|----------|--------|--------|
| Data races | 0 | ? | ✓/✗ |
| Scenarios tested | 6 | ? | ✓/✗ |
| Build clean | Yes | ? | ✓/✗ |

**Performance** (Benchmarks)
| Metric | Target | Result | Regression |
|--------|--------|--------|------------|
| Startup time | <3s | ?s | ?% |
| FPS sustained | 60 | ? | ?% |
| Memory peak | <500MB | ?MB | ?% |
| Sub-script latency | <100ms | ?ms | ?% |

**Test Coverage**
| Category | Count | Status |
|----------|-------|--------|
| E2E user scenarios | 5/5 | ✓/✗ |
| ThreadSanitizer scenarios | 6/6 | ✓/✗ |
| Valgrind scenarios | 4/4 | ✓/✗ |
| Regression tests | 10+ | ✓/✗ |

### Section 3: Known Issues & Limitations (4 pages)

**Remaining Issues** (if any)
- Issue 1: Description, severity, workaround
- Issue 2: Description, severity, workaround
- Expected: None (Phase 15 goal: zero critical issues)

**Deferred Items for Phase 16** (if any)
- Enhancement 1: Description, priority
- Enhancement 2: Description, priority
- Enhancement 3: Description, priority

**Workarounds Documented**
- For each known issue or limitation
- Step-by-step instructions
- Expected results

### Section 4: Performance Baselines (3 pages)

**Startup Time**: X.XXs
- Measured on reference hardware (MacBook Pro 2021, M1 Pro)
- Conditions: clean build, no cache
- Variability: ±0.2s

**FPS Sustained**: 60 fps
- Measured during interactive build editing
- Conditions: 1920x1200 display
- Under load: all operations smooth

**Memory Peak**: XXX MB
- Measured during maximum concurrent sub-scripts
- Conditions: complex passive tree, many items
- Garbage collection: fully functional

**Sub-Script Overhead**: XX ms
- Per-script execution time
- Cleanup overhead per timeout
- Resource tracking overhead

### Section 5: Security Assessment (3 pages)

**Security Score**: A+ (target met)
- Vulnerability count: 0 critical, 0 high
- CWE coverage: All target CWEs resolved
- Code review: Paladin approved
- Compliance: POSIX 100% compliant

**Compliance Status**
- POSIX.1-2017: Full compliance
- Memory safety: Valgrind clean
- Thread safety: ThreadSanitizer clean
- Signal handling: Async-signal-safe

### Section 6: Deployment Readiness Checklist (8 pages)

```
MANDATORY GATES - All must be ✓

Code Quality:
- [✓] Zero memory leaks (Valgrind approved)
- [✓] Zero undefined behavior (ThreadSanitizer approved)
- [✓] POSIX compliant (Paladin audit approved)
- [✓] No new CWEs introduced
- [✓] Security score A or A+

Performance:
- [✓] Startup time <3 seconds
- [✓] FPS sustained at 60
- [✓] Memory peak <500MB
- [✓] No regression >2% from Phase 14

Testing:
- [✓] E2E user scenarios all passing (Merchant M2)
- [✓] Regression test suite all passing
- [✓] ThreadSanitizer clean (Paladin P2)
- [✓] Valgrind clean (Paladin P3)
- [✓] POSIX compliance verified (Paladin P4)

Documentation:
- [✓] Deployment guide complete & tested (Bard B1)
- [✓] Architecture internals documented (Bard B2)
- [✓] Completion report generated (Bard B3)
- [✓] Release notes & known issues (Bard B4)

Known Issues:
- [✓] All known issues documented
- [✓] Workarounds provided where applicable
- [✓] No CRITICAL issues unsolved
- [✓] Phase 16 roadmap clear

Sign-Off:
- [✓] Sage: Architecture approved
- [✓] Artisan: Build approved
- [✓] Paladin: Security approved
- [✓] Merchant: Performance approved
- [✓] Bard: Documentation approved
- [✓] Mayor: FINAL APPROVAL for Phase 16
```

### Section 7: Recommendations for Phase 16 (4 pages)

**Further Optimization Opportunities**
- Potential performance improvements
- Feature enhancements possible
- Code refactoring opportunities
- Documentation improvements

**Feature Roadmap** (preview)
- Additional features under consideration
- User requests and feedback
- Priority assessment
- Estimated effort

**Performance Improvements**
- Further optimization opportunities
- Profiling data driving recommendations
- Expected impact

**Support and Operations**
- Monitoring recommendations
- Operational procedures
- Support contact escalation paths

### Success Criteria:
- [ ] 30+ pages comprehensive summary
- [ ] All achievements documented with proof
- [ ] Known issues clearly listed
- [ ] Deployment checklist complete
- [ ] Metrics tables with comparisons
- [ ] Future roadmap clear and prioritized
- [ ] Executive summary in first 2 pages

---

## Task B4: Release Notes & Known Issues (1.5 hours)

**Deliverable**: `/Users/kokage/national-operations/claudecode01/memory/PHASE15_RELEASE_NOTES.md`

**Description**: User-facing release documentation.

### Document Length Target: 10+ pages

### Section 1: What's New in Phase 15 (3 pages)

**Deferred Issue Fixes**
- Lua state memory leak: FIXED
- Undefined thread cancellation behavior: FIXED
- User-facing benefit: Improved stability on long-running sessions

**Stability Improvements**
- Cooperative shutdown mechanism
- Resource tracking and cleanup verification
- Timeout reliability improvements

**Performance Improvements**
- Sub-script overhead optimizations
- Memory usage improvements
- Startup time optimizations (if any)

### Section 2: Performance Improvements (2 pages)

**Measured Improvements**
- Memory usage reduction (if applicable)
- FPS improvements (if applicable)
- Startup time reduction (if applicable)

**Stability Metrics**
- Extended session stability
- Timeout handling reliability
- Resource cleanup verification

### Section 3: Known Issues (3 pages)

**Current Known Issues** (Phase 15)
| Issue | Description | Workaround | Severity |
|-------|-------------|-----------|----------|
| DDS.zst format | Some textures not rendering | Use BC7 format | LOW |
| ? | ? | ? | ? |

**Workarounds**
- Detailed steps for each issue
- Expected results
- Escalation procedures if workaround fails

### Section 4: Compatibility Notes (1 page)

**macOS Version Support**
- Catalina 10.15: supported
- Big Sur 11.x: supported
- Monterey 12.x: recommended
- Ventura 13.x: supported
- Sonoma 14.x: tested and supported

**Backward Compatibility**
- Builds from Phase 14: fully compatible
- Settings from Phase 14: fully compatible
- No migration needed

### Section 5: Installation & Download (1 page)

**Download Instructions**
- Where to download
- Signature verification (if applicable)
- Installation steps

**Installation Support**
- Common installation issues
- Troubleshooting links
- Support contact information

---

## Dependencies & Sequencing

```
Artisan A4 (build complete) ← **Bard can start**
    ↓
B1: Deployment Guide (3h) — can start immediately
B2: Architecture Documentation (2.5h) — can start immediately
B3: Completion Report (2.5h) — can start, finalize after testing
B4: Release Notes (1.5h) — can start, finalize after testing
    ↓
B1 + B2 + B3 + B4 can parallel
    ↓
B3/B4 finalize after M2 (E2E results) and P2-P4 (security results)
```

**Critical Path**: A4 → B1-B4 (9.5 hours parallel)

---

## Quality Gate - DOCUMENTATION APPROVAL

After completing B1-B4, Bard must provide approval:

```
BARD DOCUMENTATION APPROVAL REQUIRED:

Deployment Guide: [ ] APPROVED (50+ pages, tested)
Architecture Doc: [ ] APPROVED (40+ pages, complete)
Completion Report: [ ] APPROVED (30+ pages, comprehensive)
Release Notes: [ ] APPROVED (user-friendly, complete)

Sign-off: "All Phase 15 documentation COMPLETE and VERIFIED. System ready for end-user deployment."
```

---

## Communication Checklist

- [ ] Task received, understand A4 blocker
- [ ] Waiting for Artisan A4 build (monitor communication.yaml)
- [ ] A4 build received, B1-B4 documentation starting
- [ ] B1 Deployment Guide in progress (page count: ?)
- [ ] B2 Architecture Documentation in progress (page count: ?)
- [ ] B3 Completion Report structure drafted
- [ ] B4 Release Notes outline created
- [ ] M2 E2E results received, integrating into B3
- [ ] P2-P4 security/safety results received, integrating
- [ ] B1 Deployment Guide complete (XX pages)
- [ ] B2 Architecture Documentation complete (XX pages)
- [ ] B3 Completion Report complete (XX pages)
- [ ] B4 Release Notes complete (XX pages)
- [ ] Final documentation approval provided
- [ ] All documents in memory/ directory

---

## Reference Materials

**Phase 15 Mandate**: `queue/prophet_phase15_mandate.yaml` (sections B1-B4)
**Quick Reference**: `memory/PHASE15_QUICK_REFERENCE.md` (deliverables section)
**Phase 14 Documentation**: `memory/PHASE14_COMPLETION_REPORT.md` (template)
**Sage Research**: `memory/PHASE15_SHUTDOWN_DESIGN.md` (technical details)
**PoB2 Source**: `~/Downloads/PathOfBuilding-PoE2-dev/` (reference)

---

**Task Status**: ASSIGNED (BLOCKED until Artisan A4)
**Last Updated**: 2026-01-29T22:30:00Z
**Assigned By**: Mayor (Claude Sonnet 4.5)
