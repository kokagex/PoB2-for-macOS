# Phase 15 Task Assignment - SAGE (賢者)
# Technical Research & Architecture Authority
# Issued: 2026-01-29T22:30:00Z

project: PRJ-003 PoB2macOS
phase: Phase 15 - Architectural Refinement & Production Readiness
agent: Sage (賢者)
status: ASSIGNED
issued_by: Mayor (村長)
issued_at: "2026-01-29T22:30:00Z"

authority: Sage is technical authority for thread safety, cooperative shutdown design, and Lua cleanup validation

---

## Overall Task Summary

**Total Estimated Time**: 7 hours
**Blockers**: None (foundational research)
**Parallelization**: S1 must complete before others start; S2/S3 can parallel once S1 complete
**Quality Gate**: All documentation must meet academic rigor threshold

---

## Task S1: Cooperative Shutdown Design & Analysis (3 hours)

**Deliverable**: `/Users/kokage/national-operations/claudecode01/memory/PHASE15_SHUTDOWN_DESIGN.md`

**Description**: Produce comprehensive technical design document covering current pthread_cancel() issues and proposed cooperative shutdown architecture.

### Success Criteria Checklist:
- [ ] 2000+ words technical depth (minimum, aim for 2500+)
- [ ] All 6+ cancellation points identified with code references
- [ ] Resource leak paths documented with file:line citations
- [ ] Undefined behavior scenarios diagrammed (ASCII or structured text)
- [ ] Migration strategy low-risk and testable

### Section Requirements:

**Section 1: Current Architecture Issues** (500+ words)
- Document current pthread_cancel() usage in timeout_watchdog_thread()
- Show undefined behavior scenarios with timing diagrams
- Map resource leak paths in Lua state lifecycle
- Identify all worker thread cancellation points
- POSIX spec violation analysis

**Section 2: Proposed Cooperative Shutdown** (600+ words)
- Shutdown flag mechanism (volatile sig_atomic_t design)
- Cancellation check locations in worker thread main loop
- Signal handling strategy (SIGUSR1 for optional optimization)
- Thread state machine (runnable → shutdown requested → cleanup → exit)
- Performance impact analysis (expected <1us per check)

**Section 3: Lua State Cleanup** (500+ words)
- lua_close() correctness guarantees in multi-threaded context
- Cleanup handler ordering and lifecycle
- Resource tracking architecture (malloc/free audit trail)
- Multi-threaded Lua VM isolation verification
- Thread-local storage requirements

**Section 4: Migration Strategy** (400+ words)
- Backward compatibility analysis (LaunchSubScript() API unchanged)
- Phased rollout plan (per worker, then per subscription)
- Testing strategy for race conditions
- Rollback procedure if issues discovered

### Acceptance Criteria:
- Sage must verify architectural soundness
- No undefined behavior per POSIX.1-2017 spec
- Design approved before Artisan implementation (gating task)

---

## Task S2: Lua Cleanup Handler Implementation (2 hours)

**Deliverable**: `/Users/kokage/national-operations/claudecode01/memory/PHASE15_LUA_CLEANUP_REFERENCE.c`

**Description**: Implement reference implementation for cleanup strategy. This is NOT production code but serves as template for Artisan.

### Code Requirements:
- [ ] cleanup_lua_state_on_cancel() function (async-signal-safe)
- [ ] Resource tracking structures documented
- [ ] Verification mechanism (cleanup checklist macro)
- [ ] Example integration with subscript_worker.c
- [ ] Inline comments explaining rationale

### Reference Implementation Sections:

**1. Async-Signal-Safe Functions** (50 lines)
```c
// Helper functions suitable for signal handlers
// - write(), not printf()
// - Use only POSIX async-signal-safe functions
// - No dynamic allocation
// - No pthread calls
```

**2. Resource Tracking** (100 lines)
```c
// Thread-safe resource accounting
struct ResourceTracker {
    volatile sig_atomic_t states_allocated;
    volatile sig_atomic_t states_freed;
    volatile sig_atomic_t active_workers;
    pthread_mutex_t lock;
};
```

**3. Cleanup Handler** (80 lines)
```c
// Called automatically on thread exit or cancel
void cleanup_lua_state(void *arg) {
    // Safety: called with thread about to exit
    // Lua allocation cleanup guaranteed
}
```

**4. Integration Example** (70 lines)
- Show correct ordering with pthread_cleanup_push/pop
- Demonstrate resource counter updates
- Example timeout scenario

### Acceptance Criteria:
- Code compiles without warnings
- No dynamic allocations in signal path
- Clear lifecycle documentation
- Ready for Artisan integration

---

## Task S3: ThreadSanitizer & Valgrind Test Plan (2 hours)

**Deliverable**: `/Users/kokage/national-operations/claudecode01/memory/PHASE15_TESTING_STRATEGY.md`

**Description**: Design comprehensive testing plan for memory safety and thread safety validation.

### Test Plan Sections:

**ThreadSanitizer Configuration** (300+ words)
- Build flags: -fsanitize=thread -g
- Runtime options: TSAN_OPTIONS settings
- Expected clean output (SUMMARY: 0 races detected)
- Suppressions if needed (and why)

**Valgrind Configuration** (300+ words)
- Leak check: --leak-check=full --show-leak-kinds=all
- Memory tracking: --track-origins=yes --track-fds=yes
- Expected results: definitely lost: 0 bytes
- Test harness script

**Test Scenarios** (with expected results):
- [ ] Scenario A: Single sub-script timeout (baseline, 5 min max)
- [ ] Scenario B: 3 concurrent scripts, 1 times out (15 min)
- [ ] Scenario C: 10 sequential timeouts (stress test, 20 min)
- [ ] Scenario D: Timeout during Lua allocation (edge case)
- [ ] Scenario E: Timeout during pipe I/O (blocking call)
- [ ] Scenario F: Rapid abort/restart cycles (30x, stress)

### Deliverable Requirements:
- [ ] All 6 scenarios fully documented with step-by-step instructions
- [ ] ThreadSanitizer command lines provided verbatim
- [ ] Valgrind command lines provided verbatim
- [ ] Expected clean results documented
- [ ] Failure modes documented (what would indicate a problem)
- [ ] Estimated runtime per scenario
- [ ] Success/fail criteria for CI/CD automation

### Acceptance Criteria:
- Merchant will execute these tests in Phase 15
- All scenarios must be reproducible on clean system
- Results must be parseable for automated reporting

---

## Dependencies & Sequencing

```
S1: Shutdown Design (3h)
    ↓ (required by)
├→ S2: Lua Cleanup Reference (2h) — depends on S1 design
├→ S3: Test Plan (2h) — depends on S1 design
└→ A1: Artisan Implementation — blocked until S1 approved
    └→ P1: Paladin Security Review — blocked until S1 approved
```

**Critical Path Note**: S1 is blocking for most Phase 15 work. Prioritize completion.

---

## Authority & Sign-Off

**Sage Authority**:
- ✅ Design correctness verification (thread safety, Lua cleanup)
- ✅ Architectural soundness approval
- ✅ Test plan adequacy validation

**Sign-Off Requirement**:
Before Artisan begins A1, Sage must provide written approval of S1 design:
- "DESIGN APPROVED: Cooperative shutdown safe, no UB, migration low-risk"

---

## Communication Checklist

- [ ] Task received and understood
- [ ] S1 design in progress (update memory/communication.yaml)
- [ ] S1 design complete and ready for review (tag Mayor)
- [ ] Artisan A1 blocked pending S1 approval (notify if blocked)
- [ ] S2 reference implementation complete
- [ ] S3 test plan complete
- [ ] All deliverables in memory/ directory
- [ ] Final sign-off provided

---

## Reference Materials

**Prophet's Mandate**: `queue/prophet_phase15_mandate.yaml` (lines 70-145)
**Quick Reference**: `memory/PHASE15_QUICK_REFERENCE.md` (lines 163-194)
**Phase 14 Report**: `memory/PHASE14_COMPLETION_REPORT.md`
**POSIX Thread Spec**: IEEE Std 1003.1-2017 (pthread_cancel, pthread_cleanup_push)
**Lua Reference**: Lua 5.1 VM lifecycle and multi-threaded isolation

---

**Task Status**: ASSIGNED
**Last Updated**: 2026-01-29T22:30:00Z
**Assigned By**: Mayor (Claude Sonnet 4.5)
