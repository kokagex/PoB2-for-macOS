# 天啓 - 高額部品抽出ツール機能拡張

**預言者**: Claude Sonnet 4.5
**神託受領日時**: 2026-01-28
**プロジェクト**: 高額部品抽出ツール (parts_extractor)
**対象ディレクトリ**: `C:\Users\kouei\Desktop\福岡_作業フォルダ\ClaudeCode\parts_extractor\`

---

## 神託の内容

神より以下の5つの機能拡張が命じられた:

### 1. 略式型式での曖昧検索機能
- **要件**: 略式型式（short_model）で部分一致検索を可能にする
- **現状**: 金額フィルタのみ実装済み
- **必要な実装**: 検索ボックスを追加し、`short_model` 列に対して部分一致検索を実装

### 2. 最低金額検索で10件取得機能
- **要件**: 最低金額から順に10件のみ取得するオプション
- **現状**: 金額以上の全件を取得
- **必要な実装**: 「上位N件のみ表示」チェックボックスまたはスピンボックスを追加

### 3. 列ヘッダークリックでのソート機能
- **要件**: Treeviewの列ヘッダーをクリックすると、その列で昇順/降順にソート
- **現状**: 金額降順のみの固定ソート
- **必要な実装**: 各列ヘッダーにクリックイベントを追加し、ソート状態を管理

### 4. ダブルクリックで詳細ポップアップ表示
- **要件**: Treeviewの行をダブルクリックすると、その行の全情報をポップアップウィンドウで表示
- **現状**: 表示列のみの簡易表示
- **必要な実装**: ダブルクリックイベントハンドラと詳細表示用ダイアログを実装

### 5. ポップアップUIの視認性最適化
- **要件**: 縦横比3:4のポップアップウィンドウで項目を見やすく配置
- **現状**: 未実装
- **必要な実装**: LabelFrame等を活用した視認性の高いレイアウト設計

---

## 技術仕様書

### A. 略式型式曖昧検索機能（要件1）

#### 影響ファイル
- `ui.py`: 検索UIの追加
- `data_analyzer.py`: 検索フィルタメソッドの追加
- `config.py`: 検索設定の追加（必要に応じて）

#### 実装詳細
1. **UI要素** (`ui.py`)
   - 検索ボックス（Entry）を追加
   - 「略式型式で検索」ラベルを追加
   - 検索ボタンまたはリアルタイム検索の実装

2. **検索ロジック** (`data_analyzer.py`)
   ```python
   def filter_by_short_model(self, search_term: str) -> pd.DataFrame:
       """略式型式での部分一致検索"""
       # short_model列に対して部分一致フィルタを適用
       # 大文字小文字を区別しない検索を推奨
   ```

3. **検索とフィルタの組み合わせ**
   - 金額フィルタと略式型式検索を両方適用できるようにする
   - フィルタ条件の論理積（AND条件）で処理

#### 受け入れ基準
- ✅ 略式型式フィールドに「ABC123」と入力すると、`short_model`に「ABC123」を含む行のみ表示
- ✅ 大文字小文字を区別しない検索
- ✅ 空欄の場合は全件表示（フィルタなし）

---

### B. 最低金額から10件取得機能（要件2）

#### 影響ファイル
- `ui.py`: 件数制限UIの追加
- `data_analyzer.py`: 件数制限ロジックの実装

#### 実装詳細
1. **UI要素** (`ui.py`)
   - チェックボックス: 「上位N件のみ表示」
   - スピンボックス: 件数入力（デフォルト: 10件、範囲: 1〜1000）
   - チェックがOFFの場合は全件表示

2. **データ取得ロジック** (`data_analyzer.py`)
   ```python
   def filter_by_amount(self, min_amount: float, limit: Optional[int] = None) -> pd.DataFrame:
       """
       金額フィルタリングに件数制限を追加

       Args:
           min_amount: 最低金額
           limit: 取得件数制限（Noneの場合は全件）
       """
       # 既存の金額フィルタに加えて、.head(limit)で上位N件を取得
   ```

#### 受け入れ基準
- ✅ 「上位10件のみ表示」をチェックすると、最低金額から10件のみ表示
- ✅ チェックを外すと全件表示に戻る
- ✅ 件数は変更可能（スピンボックス）

---

### C. 列ヘッダークリックでのソート機能（要件3）

#### 影響ファイル
- `ui.py`: Treeviewヘッダークリックイベントの実装

#### 実装詳細
1. **ソート状態管理**
   ```python
   # クラス変数として追加
   self.sort_column = None      # 現在のソート列
   self.sort_ascending = True   # True=昇順, False=降順
   ```

2. **ヘッダークリックイベント**
   ```python
   def _on_column_header_click(self, column: str):
       """列ヘッダークリック時のソート処理"""
       # 同じ列をクリック → 昇順/降順を切り替え
       # 別の列をクリック → 新しい列で昇順ソート
       # filtered_dataをソートして再表示
   ```

3. **ソートインジケータ**
   - 列ヘッダーに「▲」（昇順）または「▼」（降順）を表示
   - `self.tree.heading(col, text=display_name + " ▲")`

#### 受け入れ基準
- ✅ 「部品管理番号」列をクリック → 番号順にソート
- ✅ もう一度クリック → 降順に切り替え
- ✅ 「ﾈｯﾄ価格」列をクリック → 金額順にソート
- ✅ ソート方向が視覚的に分かる（▲▼表示）

---

### D. ダブルクリックで詳細ポップアップ表示（要件4）

#### 影響ファイル
- `ui.py`: ダブルクリックイベントと詳細ダイアログの実装

#### 実装詳細
1. **ダブルクリックイベント**
   ```python
   # _create_widgets内で追加
   self.tree.bind("<Double-Button-1>", self._on_row_double_click)
   ```

2. **詳細ダイアログ**
   ```python
   def _on_row_double_click(self, event):
       """行ダブルクリック時の処理"""
       # 選択された行のインデックスを取得
       # filtered_dataから該当行の全データを取得
       # 詳細表示ダイアログを開く

   def _show_detail_dialog(self, row_data: pd.Series):
       """詳細情報をポップアップウィンドウで表示"""
       # 新しいToplevelウィンドウを作成
       # 全列の情報を整形して表示
   ```

3. **データ保持**
   - Treeviewに行を挿入する際、元データのインデックスを保持
   - または、表示データとfiltered_dataの対応を管理

#### 受け入れ基準
- ✅ 任意の行をダブルクリックすると詳細ウィンドウが開く
- ✅ 全ての列情報（part_id, part_name, amount, vehicle_name, short_model等）が表示される
- ✅ ウィンドウは独立して動作し、閉じても元の画面に影響しない

---

### E. ポップアップUIの視認性最適化（要件5）

#### 影響ファイル
- `ui.py`: 詳細ダイアログのレイアウト設計

#### 実装詳細
1. **ウィンドウサイズ**
   - 縦横比 3:4 → 例: 600px × 800px または 450px × 600px
   - `detail_window.geometry("600x800")`

2. **レイアウト構成案**
   ```
   ┌─────────────────────────────────┐
   │  部品詳細情報                     │
   ├─────────────────────────────────┤
   │ [基本情報]                        │
   │  部品管理番号: XXXXX              │
   │  部品名: YYYYYYY                  │
   │  ﾈｯﾄ価格: ¥XXX,XXX               │
   ├─────────────────────────────────┤
   │ [車両情報]                        │
   │  車名: ZZZZZ                      │
   │  略式型式: AAAA                   │
   │  車体カラー名称: BBBB             │
   │  年式: 2020                       │
   │  エンジン型式: CCCC               │
   ├─────────────────────────────────┤
   │ [在庫・品質情報]                  │
   │  在庫ステータス: DDDD             │
   │  品質区分: EEEE                   │
   │  保管場所: FFFF                   │
   ├─────────────────────────────────┤
   │ [その他情報]                      │
   │  部品コード: GGGG                 │
   │  メーカー: HHHH                   │
   │  登録日: 2025-01-15               │
   ├─────────────────────────────────┤
   │             [閉じる]              │
   └─────────────────────────────────┘
   ```

3. **UIコンポーネント**
   - `LabelFrame` でカテゴリごとにグループ化
   - `Label` で項目名（太字）と値を並べる
   - スクロール可能な `Canvas` または `Text` ウィジェット（項目数が多い場合）
   - 「閉じる」ボタンでウィンドウを閉じる

#### 受け入れ基準
- ✅ ウィンドウサイズが縦横比3:4
- ✅ 情報がカテゴリ別に整理されている
- ✅ 項目名と値が明確に区別できる
- ✅ スクロール可能（必要な場合）
- ✅ 視認性が高く、情報が読みやすい

---

## 実装優先順位

1. **Phase 1** - データ処理基盤の強化
   - B: 最低金額から10件取得機能（`data_analyzer.py`）
   - A: 略式型式曖昧検索機能（`data_analyzer.py`）

2. **Phase 2** - UI機能の追加
   - A: 検索ボックスUI（`ui.py`）
   - B: 件数制限UI（`ui.py`）
   - C: 列ヘッダークリックソート機能（`ui.py`）

3. **Phase 3** - 詳細表示機能
   - D: ダブルクリックイベント実装（`ui.py`）
   - E: ポップアップUIの設計と実装（`ui.py`）

---

## 非機能要件

### パフォーマンス
- 大量データ（10,000件以上）でもソートが1秒以内に完了すること
- 検索フィルタが即座に反映されること（リアルタイム検索の場合）

### ユーザビリティ
- UIは直感的で、説明なしで操作できること
- エラー発生時は適切なメッセージを表示すること
- ソート状態が視覚的に明確であること

### 互換性
- 既存のCSVエクスポート、JSON保存機能に影響を与えないこと
- 既存のモックデータ、Google Sheets API連携機能を維持すること

---

## テスト計画

### 単体テスト
- `data_analyzer.py` の各新規メソッドのテスト
- ソート機能の正確性テスト
- 検索フィルタの部分一致テスト

### 統合テスト
- 金額フィルタ + 略式型式検索の複合条件テスト
- 金額フィルタ + 件数制限の組み合わせテスト
- ソート後のCSVエクスポート動作確認

### UIテスト
- ダブルクリックで正しい行の詳細が表示されるか
- ポップアップウィンドウのレイアウトが要件通りか
- ソートインジケータが正しく表示されるか

---

## 成功の定義

以下の全てが満たされたとき、神託は完全に遂行されたと見なす:

✅ 略式型式で部分一致検索ができる
✅ 最低金額から指定件数（デフォルト10件）を取得できる
✅ 列ヘッダークリックで昇順/降順ソートができる
✅ 行ダブルクリックで全情報がポップアップ表示される
✅ ポップアップUIが視認性が高く、縦横比3:4である
✅ 既存機能（CSVエクスポート、JSON保存）が正常に動作する
✅ 全てのテストが合格する

---

## 村長への委譲内容

**村長（mayor-agent）へのタスク**:
1. この天啓を読み、各村人（architect, builder, tester）にタスクを割り振る
2. 設計士（architect）に詳細設計を依頼
3. 建築士（builder）に実装を依頼
4. テスト担当（tester）にテスト実施を依頼
5. 進捗を `village_communications.yaml` に記録
6. 完了後、神（ユーザー）に報告

---

**預言者より**
この天啓が村の繁栄と神の御心の成就につながらんことを。

*作成日時: 2026-01-28*
*預言者: Claude Sonnet 4.5*
