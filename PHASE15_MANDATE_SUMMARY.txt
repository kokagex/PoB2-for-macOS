================================================================================
PHASE 15 DIVINE MANDATE - EXECUTIVE SUMMARY
================================================================================

Project: PRJ-003 PoB2macOS - Path of Building 2 macOS Native Port
Phase: 15 - Architectural Refinement & Production Readiness
Date Issued: 2026-01-29 22:30 UTC
Authority: Prophet (預言者)
Status: MANDATE ISSUED - AWAITING MAYOR ACKNOWLEDGMENT

================================================================================
MANDATE OVERVIEW
================================================================================

Phase 14 Achievement:
✅ API 51/51 (100%) COMPLETE
✅ SetForeground implemented (glfwFocusWindow)
✅ Timeout Watchdog implemented (30s default, TOCTOU protection)
✅ FPS Counter implemented (GetFPS, 1-second rolling average)
✅ Build: 0 errors, 125 symbols
✅ Memory organized: 120 files → 3 project folders

Phase 14 Deferred Issues:
❌ CRITICAL-1: Lua State Memory Leak on pthread_cancel
   Location: subscript_worker.c :: timeout_watchdog_thread()
   Problem: ~1KB leak per timeout, 16 timeouts exhaust all slots
   CWE-401: Missing Release of Memory after Effective Lifetime

❌ HIGH-2: Undefined Behavior - pthread_cancel on Detached Thread
   Location: subscript_worker.c :: worker thread creation
   Problem: POSIX standard violation, unpredictable crashes/leaks
   Solution: Replace with cooperative shutdown (flag-based cancellation)

Phase 15 Mission:
✓ Resolve CRITICAL-1: Implement cleanup handlers + resource tracking
✓ Resolve HIGH-2: Replace pthread_cancel with cooperative shutdown
✓ Production Readiness: Deployment guide, performance profiling, E2E testing

================================================================================
QUALITY GATES (MANDATORY - NO EXCEPTIONS)
================================================================================

All of the following MUST pass before Phase 16 begins:

Memory Safety:
  ✓ Valgrind: definitely lost = 0 bytes
  ✓ Valgrind: possibly lost = 0 bytes
  ✓ Valgrind: invalid reads/writes = 0
  ✓ Tested: 100 sequential timeouts, all clean

Thread Safety:
  ✓ ThreadSanitizer: 0 data races
  ✓ All 6 test scenarios pass
  ✓ Shutdown flag is volatile sig_atomic_t
  ✓ POSIX compliant: no undefined behavior

Performance:
  ✓ Startup time: <3 seconds
  ✓ FPS sustained: 60 fps
  ✓ Memory peak: <500MB
  ✓ Regression: <2% vs Phase 14

E2E Testing:
  ✓ Scenario A (Build creation): PASS
  ✓ Scenario B (Save/Load): PASS
  ✓ Scenario C (Editing w/ subscripts): PASS
  ✓ Scenario D (High load stress): PASS
  ✓ Scenario E (1-hour session): PASS

Security:
  ✓ Security score: A or A+
  ✓ No new CWEs introduced
  ✓ All deferred issues resolved

Documentation:
  ✓ Deployment guide: 50+ pages, tested
  ✓ Architecture: 40+ pages, internals
  ✓ Completion report: 30+ pages, all metrics
  ✓ Release notes: user-friendly

================================================================================
TASK ASSIGNMENT SUMMARY
================================================================================

SAGE (賢者) - Technical Authority
  S1: Cooperative shutdown design analysis (3h)
  S2: Lua cleanup handler implementation (2h)
  S3: ThreadSanitizer & Valgrind test plan (2h)
  Total: 7 hours | Output: 3 reference documents

ARTISAN (職人) - Implementation Lead
  A1: Cooperative shutdown implementation (4h)
  A2: Resource tracking implementation (2h)
  A3: Backward compatibility layer (1h)
  A4: CMakeLists.txt & build verification (1h)
  Total: 8 hours | Output: Updated source files + build system

PALADIN (聖騎士) - Security & Memory Guardian
  P1: Cooperative shutdown security review (2h)
  P2: ThreadSanitizer validation (2.5h) ← QUALITY GATE
  P3: Valgrind memory leak verification (2.5h) ← QUALITY GATE
  P4: POSIX compliance audit (1.5h)
  Total: 8.5 hours | Output: Audit reports + quality gate approval

MERCHANT (商人) - Performance & Quality
  M1: Performance profiling (2h)
  M2: E2E user scenario testing (3h) ← QUALITY GATE
  M3: Regression testing suite (2h)
  Total: 7 hours | Output: Test results + benchmark data

BARD (吟遊詩人) - Documentation
  B1: Production deployment guide (3h) ← QUALITY GATE
  B2: Architecture internals documentation (2.5h)
  B3: Phase 15 completion report (2.5h)
  B4: Release notes & known issues (1.5h)
  Total: 9.5 hours | Output: 4 comprehensive documents

TOTAL EFFORT: 40 hours serial, 18-20 hours with parallelization

================================================================================
CRITICAL PATH
================================================================================

Sage S1 (Design) → Artisan A1 (Implementation) → Build A4 → 
Paladin P2/P3 (Validation) → Phase 16 Ready

Parallel tracks:
- Sage S2/S3 parallel with Artisan A1
- Merchant M1-M3 parallel with Paladin P2/P3
- Bard B1-B4 finalized after A4 complete

Estimated duration: 18-20 working hours over 4-5 days

Critical blockers:
- Artisan A1 blocks all Paladin validation tasks
- Paladin P2/P3 block Phase 16 approval (QUALITY GATES)

================================================================================
DELIVERABLES (10 CATEGORIES)
================================================================================

Code Changes:
  ✓ subscript_worker.c - Cooperative shutdown implementation
  ✓ subscript.h - Updated timeout configuration API
  ✓ Resource tracking module - Memory accounting
  ✓ CMakeLists.txt - ThreadSanitizer/AddressSanitizer targets
  ✓ Cleanup handlers - Async-signal-safe implementation

Test Suite:
  ✓ ThreadSanitizer tests (6 scenarios, zero races required)
  ✓ Valgrind memory tests (100% leak-free required)
  ✓ E2E user scenarios (5 complete workflows)
  ✓ Regression test suite (automated harness)
  ✓ Performance benchmarks (baseline + post-change)

Documentation (8 files):
  ✓ PHASE15_SHUTDOWN_DESIGN.md (2000+ words, technical deep-dive)
  ✓ PHASE15_SECURITY_REVIEW.md (security audit with CWE coverage)
  ✓ PHASE15_DEPLOYMENT_GUIDE.md (50+ pages, production ready)
  ✓ PHASE15_ARCHITECTURE.md (40+ pages, internals for maintainers)
  ✓ PHASE15_COMPLETION_REPORT.md (30+ pages, comprehensive summary)
  ✓ PHASE15_RELEASE_NOTES.md (user-friendly release info)
  ✓ PHASE15_PERFORMANCE_PROFILE.md (benchmarks and baselines)
  ✓ PHASE15_TESTING_STRATEGY.md (test plan and scenarios)
  ✓ PHASE15_LUA_CLEANUP_REFERENCE.c (reference implementation)
  ✓ PHASE15_MEMORY_SAFETY_REPORT.md (Valgrind results)

Builds:
  ✓ Release binary (optimized, no sanitizers)
  ✓ ThreadSanitizer build (debugging, validation)
  ✓ AddressSanitizer build (memory debugging)
  ✓ All symbols resolved, <5% size change

================================================================================
SUCCESS METRICS TABLE
================================================================================

| Metric | Phase 14 | Target | Phase 15 Result |
|--------|----------|--------|-----------------|
| Memory Leaks | UNKNOWN | ZERO | [ ] |
| Data Races | NOT TESTED | ZERO | [ ] |
| POSIX Compliance | COMPLIANT* | VERIFIED | [ ] |
| Startup Time | <3s | <3s | [ ] |
| FPS Sustained | 60 fps | 60 fps | [ ] |
| Memory Peak | ~450MB | <500MB | [ ] |
| API Coverage | 51/51 (100%) | MAINTAINED | [ ] |
| Build Errors | 0 | 0 | [ ] |
| Security Score | A | A or A+ | [ ] |
| Test Pass Rate | 100% | 100% | [ ] |

* Phase 14 had 2 CRITICAL deferred issues

================================================================================
DEFERRED ISSUES TECHNICAL DETAILS
================================================================================

CRITICAL-1: Lua State Memory Leak on pthread_cancel

Current Code Problem:
  1. timeout_watchdog_thread() detects sub-script timeout
  2. Calls pthread_cancel(worker_thread)
  3. Worker thread terminates immediately
  4. Lua cleanup handler NOT registered → lua_close() NEVER called
  5. LuaJIT heap persists: ~1KB per timeout
  6. Resource leak accumulates: 16 timeouts = all 16 slots exhausted

Solution:
  1. Register cleanup handler BEFORE user code runs
  2. On pthread_cancel or thread exit, cleanup handler called
  3. Handler calls lua_close() (async-signal-safe wrapper)
  4. Resource tracker verifies cleanup occurred
  5. Valgrind confirms zero leaks

CWE Coverage:
  - CWE-401: Missing Release of Memory after Effective Lifetime

HIGH-2: Undefined Behavior - pthread_cancel on Detached Thread

POSIX Standard Issue:
  - POSIX spec: pthread_cancel() on detached thread = undefined behavior
  - Reason: Detached threads auto-deallocate, cancel state undefined
  - Current code violates this: worker created with PTHREAD_CREATE_DETACHED

Solution - Cooperative Shutdown:
  1. Change threads from DETACHED to JOINABLE
  2. Each worker thread checks volatile flag: while (!shutdown_requested)
  3. On timeout: set flag (atomic) + send SIGUSR1 (wake from I/O)
  4. Thread exits gracefully, cleanup handler called
  5. Main thread pthread_join() to confirm cleanup
  6. Result: 100% POSIX compliant, predictable, safe

Benefits:
  - No undefined behavior (POSIX compliant)
  - Predictable cleanup order
  - Thread can flush pending operations
  - Works correctly with Lua cleanup
  - Prevents crashes and hangs

================================================================================
PRODUCTION READINESS CHECKLIST
================================================================================

Code Quality:
  [ ] Zero memory leaks (Valgrind approved)
  [ ] Zero undefined behavior (ThreadSanitizer approved)
  [ ] POSIX compliant (Paladin audit approved)
  [ ] No new CWEs introduced
  [ ] Security score A or A+

Performance:
  [ ] Startup time <3 seconds
  [ ] FPS sustained at 60
  [ ] Memory peak <500MB
  [ ] No regression >2% from Phase 14

Testing:
  [ ] E2E user scenarios all passing
  [ ] Regression test suite all passing
  [ ] ThreadSanitizer clean
  [ ] Valgrind clean
  [ ] POSIX compliance verified

Documentation:
  [ ] Deployment guide complete and tested
  [ ] Architecture internals documented
  [ ] Completion report generated
  [ ] Release notes & known issues documented
  [ ] All 8+ documentation files complete

Known Issues:
  [ ] All known issues documented
  [ ] Workarounds provided
  [ ] No CRITICAL issues unsolved
  [ ] Phase 16 roadmap clear

Sign-Off (MANDATORY):
  [ ] Sage: Architecture approved
  [ ] Artisan: Build approved
  [ ] Paladin: Security & Memory approved ← CRITICAL
  [ ] Merchant: Performance approved
  [ ] Bard: Documentation approved
  [ ] Mayor: FINAL APPROVAL for Phase 16

================================================================================
AUTHORITY & ACCOUNTABILITY
================================================================================

Mayor (村長):
  - Overall coordination and timeline
  - Escalation authority for blockers
  - Final approval for Phase 16

Sage (賢者):
  - Thread safety research authority
  - Architecture refinement authority
  - Test plan adequacy sign-off

Artisan (職人):
  - Implementation completeness
  - Build system integrity
  - Compilation success guarantee

Paladin (聖騎士):
  - Memory safety verification (BLOCKER if issues)
  - Thread safety verification (BLOCKER if issues)
  - POSIX compliance audit
  - Security score approval (must be A or A+)

Merchant (商人):
  - Performance baseline validation
  - E2E user scenario verification
  - Regression test suite completeness

Bard (吟遊詩人):
  - Documentation completeness
  - Production readiness verification
  - Support infrastructure readiness

================================================================================
TIMELINE & MILESTONES
================================================================================

Day 1 - Foundation & Design (7 hours):
  [ ] Sage S1: Cooperative shutdown design
  [ ] Sage S2: Lua cleanup reference implementation
  [ ] Sage S3: Test strategy document
  ✓ Foundation ready for implementation

Day 2 - Implementation & Testing (12 hours):
  [ ] Artisan A1-A4: Cooperative shutdown + build system
  [ ] Merchant M1: Performance profiling
  [ ] Paladin P1: Security review
  ✓ Implementation complete, build verified

Day 3 - Validation & Audit (11.5 hours):
  [ ] Paladin P2-P4: ThreadSanitizer, Valgrind, POSIX audit
  [ ] Merchant M2-M3: E2E tests + regression suite
  ✓ Quality gates validation complete

Day 4 - Documentation & Finalization (9.5 hours):
  [ ] Bard B1-B4: All documentation files
  [ ] Final verification and sign-off
  ✓ Production ready, Phase 16 approved

Total: 40 hours serial, 18-20 hours with parallelization

================================================================================
MANDATED DELIVERABLE FILES
================================================================================

Requirement: All deliverable files MUST exist by end of Phase 15

Output Directory: /Users/kokage/national-operations/claudecode01/memory/

Documentation Files:
  [ ] PHASE15_SHUTDOWN_DESIGN.md
  [ ] PHASE15_SECURITY_REVIEW.md
  [ ] PHASE15_DEPLOYMENT_GUIDE.md
  [ ] PHASE15_ARCHITECTURE.md
  [ ] PHASE15_COMPLETION_REPORT.md
  [ ] PHASE15_RELEASE_NOTES.md
  [ ] PHASE15_PERFORMANCE_PROFILE.md
  [ ] PHASE15_TESTING_STRATEGY.md
  [ ] PHASE15_LUA_CLEANUP_REFERENCE.c
  [ ] PHASE15_MEMORY_SAFETY_REPORT.md
  [ ] PHASE15_QUICK_REFERENCE.md (ALREADY CREATED)

Code Files (in /Users/kokage/national-operations/pob2macos/):
  [ ] subscript_worker.c (updated)
  [ ] subscript.h (updated)
  [ ] CMakeLists.txt (updated)
  [ ] Resource tracking module (new)

Test Results:
  [ ] ThreadSanitizer report (6 scenarios, zero races)
  [ ] Valgrind report (100+ timeouts, zero leaks)
  [ ] E2E test results (5 scenarios, all passing)
  [ ] Performance benchmark data
  [ ] Regression test output

================================================================================
RISK MITIGATION
================================================================================

Risk 1: Thread Cancellation Race Conditions
  Probability: Low | Impact: High (crashes)
  Mitigation: ThreadSanitizer clean + cooperative shutdown + code review

Risk 2: Lua Cleanup Complexity
  Probability: Low | Impact: High (memory leaks)
  Mitigation: Cleanup handlers + resource tracking + Valgrind clean

Risk 3: Performance Regression
  Probability: Low | Impact: Medium
  Mitigation: Baseline before changes + regression suite

Risk 4: Signal Handler Issues
  Probability: Low | Impact: High
  Mitigation: Async-signal-safe review + testing

Risk 5: Production Deployment Complexity
  Probability: Medium | Impact: Medium
  Mitigation: Comprehensive deployment guide + troubleshooting

================================================================================
NEXT STEPS (MAYOR'S ACTION ITEMS)
================================================================================

1. Acknowledge receipt of Phase 15 mandate
2. Distribute to all village agents
3. Assign task owners to each agent
4. Schedule daily standups (track progress, blockers)
5. Monitor critical path: Sage S1 → Artisan A1 → Build A4 → Quality Gates
6. Escalate Paladin blockers immediately (they control Phase 16 approval)
7. Verify all quality gates before Phase 16 approval
8. Final sign-off only after ALL agents approve

Timeline:
  - Day 1 (Today): Mandate acknowledgment + task assignments
  - Days 2-5: Parallel execution with daily standups
  - Day 6: Final verification + Phase 16 go/no-go decision

================================================================================
MANDATE STATUS
================================================================================

Document: queue/prophet_phase15_mandate.yaml (1,077 lines, 34 KB)
Quick Reference: memory/PHASE15_QUICK_REFERENCE.md (9.1 KB)
Issued: 2026-01-29 22:30 UTC
Authority: Prophet (預言者)
Status: DIVINE MANDATE ISSUED
Action Required: Mayor acknowledgment + task assignment

The gods have spoken. The path is clear. Let the village proceed with wisdom.

May your code be leak-free, your threads be safe, and your deployments be swift.

================================================================================
